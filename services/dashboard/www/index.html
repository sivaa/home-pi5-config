<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Home Climate</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Modularized CSS -->
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/layout.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/views/comfort-score.css">
  <link rel="stylesheet" href="styles/views/bar-compare.css">
  <link rel="stylesheet" href="styles/views/floor-plan.css">
  <link rel="stylesheet" href="styles/views/ambient.css">
  <link rel="stylesheet" href="styles/views/timeline.css">
  <link rel="stylesheet" href="styles/views/classic.css">
  <link rel="stylesheet" href="styles/views/lights.css">
  <link rel="stylesheet" href="styles/views/3d-view.css">
  <link rel="stylesheet" href="styles/views/sensor-config.css">
  <link rel="stylesheet" href="styles/views/co2-view.css">
  <link rel="stylesheet" href="styles/views/isometric.css">
  <link rel="stylesheet" href="styles/views/network.css">

  <!-- Three.js for 3D Floor Plan -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- OrbitControls is now loaded via js/three/orbit-controls.js module in app.js -->

  <!-- Main app module (imports Alpine as ES module and starts it) -->
  <script type="module" src="./js/app.js"></script>
</head>
<body>
  <div class="app-container" x-data="app()" x-init="init()">

    <!-- Header -->
    <header class="app-header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="header-title">Home Climate</h1>
          <div class="status-badge"
               :class="{ 'disconnected': !$store.mqtt.connected && !$store.mqtt.connecting, 'connecting': $store.mqtt.connecting }">
            <span class="loading-indicator loading-sm" x-show="$store.mqtt.connecting"></span>
            <span class="status-dot-header" x-show="!$store.mqtt.connecting" :class="{ 'connected': $store.mqtt.connected }"></span>
            <span x-text="$store.mqtt.connecting ? 'Connecting' : ($store.mqtt.connected ? 'Live' : 'Offline')"></span>
          </div>
        </div>
        <div class="header-right">
          <div class="date-time" x-text="currentDateTime"></div>
          <div class="last-update" x-text="'Last update: ' + lastUpdateText"></div>
        </div>
      </div>
    </header>

    <!-- Navigation Menu -->
    <nav class="nav-container">
      <div class="nav-tabs">
        <button class="nav-tab" :class="{ active: currentView === 'comfort' }"
                @click="setView('comfort')" title="Comfort Score (Press 1)">
          <span class="nav-icon">üéØ</span>
          <span class="nav-label">Score</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'compare' }"
                @click="setView('compare')" title="Room Comparison (Press 2)">
          <span class="nav-icon">üìä</span>
          <span class="nav-label">Compare</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'floor' }"
                @click="setView('floor')" title="Floor Plan (Press 3)">
          <span class="nav-icon">üè†</span>
          <span class="nav-label">Floor Plan</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'ambient' }"
                @click="setView('ambient')" title="Ambient Display (Press 4)">
          <span class="nav-icon">üå°Ô∏è</span>
          <span class="nav-label">Ambient</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'timeline' }"
                @click="setView('timeline')" title="Timeline Story (Press 5)">
          <span class="nav-icon">üìñ</span>
          <span class="nav-label">Timeline</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'classic' }"
                @click="setView('classic')" title="Classic Cards (Press 6)">
          <span class="nav-icon">üÉè</span>
          <span class="nav-label">Classic</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'lights' }"
                @click="setView('lights')" title="Light Control (Press 7)">
          <span class="nav-icon">üí°</span>
          <span class="nav-label">Lights</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === '3d' }"
                @click="setView('3d')" title="3D Floor Plan (Press 8)">
          <span class="nav-icon">üè†</span>
          <span class="nav-label">3D</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'isometric' }"
                @click="setView('isometric')" title="Isometric View (Press I)">
          <span class="nav-icon">üî∑</span>
          <span class="nav-label">Iso</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'config' }"
                @click="setView('config')" title="Sensor Config (Press 9)">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span class="nav-label">Config</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'co2' }"
                @click="setView('co2')" title="CO2 Monitor (Press 0)">
          <span class="nav-icon">üí®</span>
          <span class="nav-label">CO2</span>
        </button>
        <button class="nav-tab" :class="{ active: currentView === 'network' }"
                @click="setView('network')" title="Zigbee Network (Press N)">
          <span class="nav-icon">üì°</span>
          <span class="nav-label">Network</span>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="app-main">
      <div class="view-container">

        <!-- Vision 1: Comfort Score -->
        <div x-show="currentView === 'comfort'" x-cloak x-data="comfortScoreView()">
          <div class="comfort-score-view">
            <div class="score-hero" @click="showBreakdown = !showBreakdown">
              <div class="score-label-top">YOUR HOME IS</div>
              <div class="score-circle" :style="{ '--score-color': getColor() }">
                <svg viewBox="0 0 200 200" class="score-ring">
                  <circle cx="100" cy="100" r="90" fill="none" stroke="var(--color-border)" stroke-width="8"/>
                  <circle cx="100" cy="100" r="90" fill="none" :stroke="getColor()" stroke-width="8"
                          stroke-linecap="round" :stroke-dasharray="getScoreArc()"
                          transform="rotate(-90 100 100)" class="score-arc"/>
                </svg>
                <div class="score-content">
                  <span class="score-number" :style="{ color: getColor() }" x-text="homeScore"></span>
                  <span class="score-label" x-text="getLabel()"></span>
                </div>
              </div>
              <div class="score-hint">Tap for breakdown</div>
            </div>

            <div class="score-breakdown" x-show="showBreakdown" x-transition>
              <div class="breakdown-title">Score Components</div>
              <div class="breakdown-item">
                <span class="breakdown-label">Temperature (70%)</span>
                <div class="breakdown-bar">
                  <div class="breakdown-fill" :style="{ width: (homeScore * 0.7) + '%', background: 'var(--color-primary)' }"></div>
                </div>
              </div>
              <div class="breakdown-item">
                <span class="breakdown-label">Humidity (30%)</span>
                <div class="breakdown-bar">
                  <div class="breakdown-fill" :style="{ width: (homeScore * 0.3) + '%', background: 'var(--color-success)' }"></div>
                </div>
              </div>
            </div>

            <div class="room-scores">
              <template x-for="room in roomScores" :key="room.id">
                <button class="room-pill" @click="openRoom(room)" :style="{ '--pill-color': getRoomColor(room.score) }">
                  <span class="pill-icon" x-text="room.icon"></span>
                  <span class="pill-score" :style="{ color: getRoomColor(room.score) }" x-text="room.score"></span>
                  <span class="pill-dot" :style="{ background: getRoomColor(room.score) }"></span>
                </button>
              </template>
            </div>

            <div class="room-labels">
              <template x-for="room in roomScores" :key="room.id + '-label'">
                <span class="room-label-text" x-text="room.name.split(' ')[0]"></span>
              </template>
            </div>

            <div class="comfort-spectrum">
              <div class="spectrum-bar">
                <div class="spectrum-gradient"></div>
                <div class="spectrum-marker" :style="{ left: homeScore + '%' }">
                  <div class="marker-line"></div>
                  <div class="marker-label">You</div>
                </div>
              </div>
              <div class="spectrum-labels">
                <span>Poor</span>
                <span>Okay</span>
                <span>Perfect</span>
              </div>
            </div>

            <div class="suggestions" x-show="suggestions.length > 0">
              <template x-for="(suggestion, index) in suggestions" :key="index">
                <div class="suggestion-card" :class="'suggestion-' + suggestion.type">
                  <span class="suggestion-icon" x-text="suggestion.icon"></span>
                  <div class="suggestion-content">
                    <div class="suggestion-title" x-text="suggestion.title"></div>
                    <div class="suggestion-message" x-text="suggestion.message"></div>
                  </div>
                  <button class="suggestion-dismiss" @click="suggestions.splice(index, 1)">&times;</button>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Vision 2: Bar Compare -->
        <div x-show="currentView === 'compare'" x-cloak x-data="barCompareView()">
          <div class="bar-compare-view">
            <div class="bar-controls">
              <div class="view-toggle">
                <button class="btn btn-secondary" :class="{ active: viewMode === 'temperature' }"
                        @click="setViewMode('temperature')">üå°Ô∏è Temp</button>
                <button class="btn btn-secondary" :class="{ active: viewMode === 'humidity' }"
                        @click="setViewMode('humidity')">üíß Humid</button>
                <button class="btn btn-secondary" :class="{ active: viewMode === 'both' }"
                        @click="setViewMode('both')">Both</button>
              </div>
              <div class="sort-controls">
                <select class="sort-select" x-model="sortBy">
                  <option value="temperature">Sort: Temperature</option>
                  <option value="humidity">Sort: Humidity</option>
                  <option value="name">Sort: Name</option>
                  <option value="score">Sort: Comfort</option>
                </select>
                <button class="sort-direction" @click="sortDirection = sortDirection === 'desc' ? 'asc' : 'desc'">
                  <span x-text="sortDirection === 'desc' ? '‚Üì' : '‚Üë'"></span>
                </button>
              </div>
            </div>

            <div class="charts-container" :class="{ 'single-chart': viewMode !== 'both' }">
              <div class="bar-chart" x-show="viewMode === 'temperature' || viewMode === 'both'">
                <h3 class="chart-title">üå°Ô∏è Temperature</h3>
                <div class="chart-wrapper">
                  <div class="comfort-zone" :style="getComfortZoneStyle('temperature')"></div>
                  <template x-for="room in sortedRooms" :key="room.id + '-temp'">
                    <div class="bar-row" @click="openRoom(room)">
                      <div class="bar-label">
                        <span class="bar-icon" x-text="room.icon"></span>
                        <span class="bar-name" x-text="room.name"></span>
                      </div>
                      <div class="bar-track">
                        <div class="bar-fill" :style="{ width: getBarWidth(room.temperature, 'temperature') + '%', background: getBarColor(room.temperature, 'temperature') }"></div>
                      </div>
                      <div class="bar-value" x-text="room.temperature.toFixed(1) + '¬∞'"></div>
                    </div>
                  </template>
                  <div class="scale-labels">
                    <template x-for="label in getScaleLabels('temperature')" :key="label">
                      <span x-text="label"></span>
                    </template>
                  </div>
                </div>
              </div>

              <div class="bar-chart" x-show="viewMode === 'humidity' || viewMode === 'both'">
                <h3 class="chart-title">üíß Humidity</h3>
                <div class="chart-wrapper">
                  <div class="comfort-zone" :style="getComfortZoneStyle('humidity')"></div>
                  <template x-for="room in sortedRooms" :key="room.id + '-humid'">
                    <div class="bar-row" @click="openRoom(room)">
                      <div class="bar-label">
                        <span class="bar-icon" x-text="room.icon"></span>
                        <span class="bar-name" x-text="room.name"></span>
                      </div>
                      <div class="bar-track">
                        <div class="bar-fill" :style="{ width: getBarWidth(room.humidity, 'humidity') + '%', background: getBarColor(room.humidity, 'humidity') }"></div>
                      </div>
                      <div class="bar-value" x-text="room.humidity.toFixed(0) + '%'"></div>
                    </div>
                  </template>
                  <div class="scale-labels">
                    <template x-for="label in getScaleLabels('humidity')" :key="label">
                      <span x-text="label"></span>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <div class="insights-section" x-show="insights.length > 0">
              <h3 class="insights-title">üìä Auto-Insights</h3>
              <div class="insights-list">
                <template x-for="insight in insights" :key="insight.message">
                  <div class="insight-card" :class="getInsightClass(insight.type)">
                    <span class="insight-icon" x-text="insight.icon"></span>
                    <div class="insight-content">
                      <div class="insight-title" x-text="insight.title"></div>
                      <div class="insight-message" x-text="insight.message"></div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- Vision 3: Floor Plan -->
        <div x-show="currentView === 'floor'" x-cloak x-data="floorPlanView()">
          <div class="floor-plan-view">
            <div class="floor-controls">
              <div class="view-toggle">
                <button class="btn btn-secondary" :class="{ active: viewType === 'temperature' }"
                        @click="setViewType('temperature')">üå°Ô∏è Temperature</button>
                <button class="btn btn-secondary" :class="{ active: viewType === 'humidity' }"
                        @click="setViewType('humidity')">üíß Humidity</button>
              </div>
            </div>

            <div class="floor-plan-container">
              <svg class="floor-plan-svg" :viewBox="'0 0 ' + layout.width + ' ' + layout.height">
                <!-- Compass -->
                <g class="compass" transform="translate(590, 30)">
                  <text font-size="12" fill="var(--color-text-tertiary)" text-anchor="middle">N</text>
                  <line x1="0" y1="8" x2="0" y2="20" stroke="var(--color-text-tertiary)" stroke-width="2"/>
                  <polygon points="-3,8 3,8 0,4" fill="var(--color-text-tertiary)"/>
                </g>

                <!-- Balcony (left of Living Room, west side) -->
                <g class="balcony">
                  <rect x="10" y="50" width="55" height="120" fill="none" stroke="var(--color-success)"
                        stroke-width="2" stroke-dasharray="5,3" rx="4"/>
                  <text x="37" y="115" font-size="10" fill="var(--color-success)" text-anchor="middle">Balcony</text>
                </g>

                <!-- Hallway (center corridor connecting all rooms) -->
                <rect x="295" y="235" width="130" height="100" fill="var(--color-bg)"
                      stroke="var(--color-border)" stroke-width="1" rx="4" opacity="0.5"/>
                <text x="360" y="290" font-size="11" fill="var(--color-text-tertiary)" text-anchor="middle">Hallway</text>

                <!-- Rooms -->
                <template x-for="room in rooms" :key="room.id">
                  <g class="floor-room" @click="openRoom(room)" style="cursor: pointer;">
                    <rect :x="room.x" :y="room.y" :width="room.width" :height="room.height"
                          :fill="room.color" stroke="var(--color-border)" stroke-width="2" rx="8" class="room-rect"/>
                    <text :x="room.x + room.width/2" :y="room.y + room.height/2 - 15"
                          text-anchor="middle" font-size="14" font-weight="500" fill="var(--color-text)"
                          x-text="room.name"></text>
                    <text :x="room.x + room.width/2" :y="room.y + room.height/2 + 10"
                          text-anchor="middle" font-size="24" font-weight="600" fill="var(--color-text)"
                          x-text="getValue(room)"></text>
                    <text :x="room.x + room.width/2" :y="room.y + room.height/2 + 30"
                          text-anchor="middle" font-size="12" fill="var(--color-text-secondary)"
                          x-text="viewType === 'temperature' ? (room.humidity?.toFixed(0) + '%' || '') : (room.temperature?.toFixed(1) + '¬∞' || '')"></text>
                    <text :x="room.x + room.width - 20" :y="room.y + room.height - 15" font-size="16" x-text="room.icon"></text>
                  </g>
                </template>

                <!-- Main Entry Door (east side at Bedroom) -->
                <g transform="translate(595, 80)">
                  <rect x="-10" y="-30" width="14" height="60" fill="var(--color-surface)"
                        stroke="var(--color-primary)" stroke-width="2" rx="3"/>
                  <text x="-3" y="45" font-size="8" fill="var(--color-primary)" text-anchor="middle" font-weight="500">üö™</text>
                </g>

                <!-- Windows indicators -->
                <g class="windows" opacity="0.6">
                  <!-- Living room window (west/left wall, near balcony door) -->
                  <rect x="66" y="130" width="4" height="50" fill="var(--color-info)" rx="2"/>
                  <!-- Bedroom window (east/right wall) -->
                  <rect x="590" y="160" width="4" height="50" fill="var(--color-info)" rx="2"/>
                  <!-- Study window (west/left wall) -->
                  <rect x="16" y="320" width="4" height="50" fill="var(--color-info)" rx="2"/>
                  <!-- Kitchen window (east/right wall) -->
                  <rect x="605" y="270" width="4" height="40" fill="var(--color-info)" rx="2"/>
                  <!-- Bathroom window (east/right wall) -->
                  <rect x="605" y="380" width="4" height="35" fill="var(--color-info)" rx="2"/>
                </g>
              </svg>
            </div>

            <div class="floor-legend">
              <div class="legend-title" x-text="viewType === 'temperature' ? 'Temperature' : 'Humidity'"></div>
              <div class="legend-items">
                <template x-for="item in getLegendItems()" :key="item.label">
                  <div class="legend-item">
                    <div class="legend-color" :style="{ background: item.color }"></div>
                    <span class="legend-label" x-text="item.label"></span>
                  </div>
                </template>
              </div>
            </div>

            <div class="floor-tip">Tap any room for detailed history</div>
          </div>
        </div>

        <!-- Vision 4: Ambient -->
        <div x-show="currentView === 'ambient'" x-cloak x-data="ambientView()">
          <div class="ambient-view" :style="{ background: getBackgroundColor() }" :class="{ 'dark-mode': isDarkMode }"
               @click="showDetailsOverlay()">
            <div class="ambient-main">
              <div class="ambient-temperature">
                <span x-text="currentRoom.temperature?.toFixed(1) || '--'"></span>
                <span class="ambient-unit">¬∞</span>
              </div>
              <div class="ambient-room-name" x-text="currentRoom.name"></div>
              <div class="ambient-humidity">
                <span>üíß</span>
                <span x-text="(currentRoom.humidity?.toFixed(0) || '--') + '%'"></span>
              </div>
            </div>

            <div class="ambient-details" x-show="showDetails" x-transition.opacity>
              <div class="detail-item">
                <span class="detail-label">Today</span>
                <span class="detail-value" x-text="getMinMaxToday()"></span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Trend</span>
                <span class="detail-value trend" x-text="getTrend()"></span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Updated</span>
                <span class="detail-value" x-text="formatLastUpdate()"></span>
              </div>
            </div>

            <div class="ambient-room-dots">
              <template x-for="(room, index) in rooms" :key="room.id">
                <button class="room-dot-btn" :class="{ active: currentRoomIndex === index }"
                        @click.stop="selectRoom(index)">
                  <div class="dot-circle"></div>
                  <div class="dot-label">
                    <span class="dot-temp" x-text="room.temperature?.toFixed(0) + '¬∞'"></span>
                    <span class="dot-name" x-text="room.name.split(' ')[0]"></span>
                  </div>
                </button>
              </template>
            </div>

            <div class="ambient-hint">
              <span>‚Üê swipe to change room ‚Üí</span>
              <span class="hint-secondary" x-show="isDarkMode">Double-tap for light mode</span>
            </div>

            <div class="auto-rotate-indicator" x-show="autoRotate">üîÑ Auto-rotating</div>
          </div>
        </div>

        <!-- Vision 5: Timeline -->
        <div x-show="currentView === 'timeline'" x-cloak x-data="timelineView()">
          <div class="timeline-view">
            <div class="timeline-header">
              <h2 class="timeline-title">üìñ Today's Climate Story</h2>
              <div class="date-selector">
                <button class="btn btn-secondary" :class="{ active: selectedDate === 'today' }"
                        @click="setDate('today')">Today</button>
                <button class="btn btn-secondary" :class="{ active: selectedDate === 'yesterday' }"
                        @click="setDate('yesterday')">Yesterday</button>
                <button class="btn btn-secondary" :class="{ active: selectedDate === 'week' }"
                        @click="setDate('week')">This Week</button>
              </div>
            </div>

            <template x-if="getTodaySummary()">
              <div class="summary-card">
                <div class="summary-title">üìä Summary</div>
                <div class="summary-grid">
                  <div class="summary-item">
                    <span class="summary-label">Temperature Range</span>
                    <span class="summary-value" x-text="getTodaySummary().minTemp + '¬∞ ‚Äî ' + getTodaySummary().maxTemp + '¬∞'"></span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Most Stable</span>
                    <span class="summary-value" x-text="getTodaySummary().mostStable || '--'"></span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Most Variable</span>
                    <span class="summary-value" x-text="getTodaySummary().mostVolatile || '--'"></span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Events Detected</span>
                    <span class="summary-value" x-text="getTodaySummary().eventCount"></span>
                  </div>
                </div>
              </div>
            </template>

            <div class="timeline-content">
              <div class="timeline-now" x-show="selectedDate === 'today'">
                <div class="now-marker">NOW</div>
                <div class="now-line"></div>
              </div>

              <template x-if="events.length === 0 && !loading">
                <div class="no-events">
                  <span class="no-events-icon">üì≠</span>
                  <span class="no-events-text">No significant events detected</span>
                  <span class="no-events-hint">Events appear when temperature changes rapidly or reaches peaks</span>
                </div>
              </template>

              <template x-if="loading">
                <div class="loading-events">
                  <span class="loading-indicator"></span>
                  <span>Analyzing climate data...</span>
                </div>
              </template>

              <div class="timeline-events">
                <template x-for="event in events" :key="event.time + event.room">
                  <div class="timeline-event" :class="getEventClass(event.type)" @click="openRoom(event.room)">
                    <div class="event-time-marker">
                      <span class="event-time" x-text="formatTime(event.time)"></span>
                      <div class="event-dot"></div>
                    </div>
                    <div class="event-card">
                      <div class="event-header">
                        <span class="event-icon" x-text="event.eventIcon"></span>
                        <span class="event-room-icon" x-text="event.icon"></span>
                        <span class="event-title" x-text="event.title"></span>
                      </div>
                      <template x-if="event.cause">
                        <div class="event-cause">
                          <span class="cause-icon">üí°</span>
                          <span class="cause-text" x-text="'Likely: ' + event.cause.text"></span>
                        </div>
                      </template>
                      <template x-if="event.type === 'RAPID_RISE' || event.type === 'RAPID_DROP'">
                        <div class="event-details">
                          <span x-text="event.value.toFixed(1) + '¬∞ ‚Üí ' + event.endValue.toFixed(1) + '¬∞'"></span>
                          <span class="event-duration" x-text="'(' + event.duration + ' min)'"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

              <div class="timeline-midnight" x-show="selectedDate === 'today'">
                <div class="midnight-line"></div>
                <div class="midnight-label">MIDNIGHT</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vision 6: Classic Cards View -->
        <div x-show="currentView === 'classic'" x-cloak x-data="classicView()">
          <div class="classic-view">
            <!-- Room Grid -->
            <div class="classic-grid">
              <template x-for="room in rooms" :key="room.id">
                <div class="classic-card" :class="{ 'stale': isStale(room) }" @click="openRoom(room)">
                  <div class="classic-comfort" :class="getComfortClass(room.temperature)"></div>

                  <div class="classic-header">
                    <div class="classic-room-info">
                      <div class="classic-icon" x-text="room.icon"></div>
                      <div class="classic-name" x-text="room.name"></div>
                    </div>
                    <div class="classic-updated" x-text="formatUpdate(room.lastSeen)"></div>
                  </div>

                  <div class="classic-values">
                    <div class="classic-temp">
                      <template x-if="room.temperature !== null">
                        <span><span x-text="room.temperature.toFixed(1)"></span><span class="unit">¬∞</span></span>
                      </template>
                      <template x-if="room.temperature === null">
                        <span class="no-data">--</span>
                      </template>
                    </div>
                    <div class="classic-humidity">
                      <span class="humidity-icon">üíß</span>
                      <template x-if="room.humidity !== null">
                        <span x-text="room.humidity.toFixed(0) + '%'"></span>
                      </template>
                      <template x-if="room.humidity === null">
                        <span>--%</span>
                      </template>
                    </div>
                  </div>

                  <div class="classic-sparkline">
                    <svg :id="'classic-spark-' + room.id" class="sparkline-svg" preserveAspectRatio="none"></svg>
                  </div>
                </div>
              </template>
            </div>

            <!-- Average Card -->
            <div class="classic-average">
              <div class="avg-section">
                <div class="avg-label">Home Average Temperature</div>
                <div class="avg-value">
                  <template x-if="avgTemperature !== null">
                    <span><span x-text="avgTemperature.toFixed(1)"></span><span class="avg-unit">¬∞C</span></span>
                  </template>
                  <template x-if="avgTemperature === null">
                    <span class="no-data">--</span>
                  </template>
                </div>
              </div>
              <div class="avg-divider"></div>
              <div class="avg-section">
                <div class="avg-label">Home Average Humidity</div>
                <div class="avg-value">
                  <template x-if="avgHumidity !== null">
                    <span><span x-text="avgHumidity.toFixed(0)"></span><span class="avg-unit">%</span></span>
                  </template>
                  <template x-if="avgHumidity === null">
                    <span class="no-data">--</span>
                  </template>
                </div>
              </div>
              <div class="avg-divider hidden-mobile"></div>
              <div class="avg-chart">
                <svg id="classic-spark-avg" class="sparkline-svg" preserveAspectRatio="none"></svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Vision 7: Lights Control -->
        <div x-show="currentView === 'lights'" x-cloak x-data="lightsView()">
          <div class="lights-view">
            <div class="lights-header">
              <h2>üí° Light Control</h2>
              <p class="lights-subtitle">
                Control your IKEA FLOALT panel lights
                <span class="loading-indicator" x-show="$store.lights.initializing && $store.mqtt.connected"></span>
              </p>
            </div>

            <!-- Initializing overlay -->
            <div class="lights-initializing" x-show="$store.lights.initializing && $store.mqtt.connected" x-transition>
              <span class="loading-indicator loading-lg"></span>
              <span>Loading light states...</span>
            </div>

            <!-- Not connected warning -->
            <div class="lights-warning" x-show="!$store.mqtt.connected">
              <span class="loading-indicator"></span>
              <span>Connecting to MQTT...</span>
            </div>

            <!-- Master Control Toggle -->
            <div class="master-control"
                 :class="{
                   'master-on': $store.lights.list.every(l => l.state === 'ON'),
                   'master-syncing': $store.lights.syncing,
                   'master-disabled': !$store.mqtt.connected || $store.lights.initializing
                 }">
              <div class="master-info">
                <span class="master-icon">üí°</span>
                <div class="master-text">
                  <span class="master-label">Master Control</span>
                  <span class="master-status" x-text="$store.lights.lightsOnCount + ' of ' + $store.lights.list.length + ' lights on'"></span>
                </div>
              </div>
              <button class="light-toggle master-toggle"
                      :class="{ 'toggle-on': $store.lights.list.every(l => l.state === 'ON'), 'toggle-syncing': $store.lights.syncing }"
                      @click="$store.lights.toggleAllLights()"
                      :disabled="$store.lights.syncing || !$store.mqtt.connected || $store.lights.initializing">
                <div class="toggle-track">
                  <div class="toggle-thumb"></div>
                </div>
              </button>
            </div>

            <!-- Light Cards -->
            <div class="lights-grid" :class="{ 'lights-disabled': !$store.mqtt.connected || $store.lights.initializing }">
              <template x-for="light in $store.lights.list" :key="light.id">
                <div class="light-card" :class="{ 'light-on': light.state === 'ON' && light.available, 'light-off': light.state === 'OFF' && light.available, 'light-syncing': light.syncing, 'light-unavailable': !light.available }">
                  <!-- Unavailable overlay -->
                  <div class="light-unavailable-overlay" x-show="!light.available" x-transition.opacity>
                    <span class="unavailable-icon">‚ö°</span>
                    <span class="unavailable-text">Offline</span>
                  </div>
                  <!-- Syncing overlay -->
                  <div class="light-syncing-overlay" x-show="light.syncing && light.available" x-transition.opacity>
                    <span class="loading-indicator"></span>
                  </div>

                  <div class="light-header">
                    <div class="light-info">
                      <span class="light-icon" x-text="light.icon"></span>
                      <div class="light-details">
                        <span class="light-name" x-text="light.name"></span>
                        <span class="light-status">
                          <span x-show="!light.available" class="unavailable-status">Offline</span>
                          <span x-show="light.available && light.syncing" class="syncing-text">Syncing...</span>
                          <span x-show="light.available && !light.syncing" x-text="light.state === 'ON' ? 'On' : 'Off'"></span>
                        </span>
                      </div>
                    </div>
                    <button class="light-toggle" :class="{ 'toggle-on': light.state === 'ON' && light.available, 'toggle-syncing': light.syncing, 'toggle-unavailable': !light.available }"
                            @click="$store.lights.toggleLight(light)" :disabled="light.syncing || !light.available">
                      <div class="toggle-track">
                        <div class="toggle-thumb">
                          <span class="loading-indicator loading-sm" x-show="light.syncing"></span>
                        </div>
                      </div>
                    </button>
                  </div>

                  <!-- Brightness Slider -->
                  <div class="light-control" x-show="light.state === 'ON' && light.available" x-transition
                       :class="{ 'control-disabled': !$store.mqtt.connected || $store.lights.initializing || light.syncing }">
                    <div class="control-row">
                      <label class="control-label">
                        <span class="control-icon">üîÜ</span>
                        Brightness
                      </label>
                      <span class="control-value">
                        <span x-show="light.syncing" class="control-syncing">‚ü≥</span>
                      </span>
                    </div>
                    <div class="slider-wrapper">
                      <input type="range" class="slider brightness-slider" min="1" max="254"
                             x-model="light.brightness"
                             :disabled="!$store.mqtt.connected || $store.lights.initializing"
                             @change="$store.lights.setBrightness(light, $event.target.value)"
                             :style="'background: linear-gradient(90deg, rgba(255,220,180,0.8) 0%, rgba(255,240,210,0.6) ' + (light.brightness / 254 * 100) + '%, rgba(245,245,247,1) ' + (light.brightness / 254 * 100) + '%, rgba(245,245,247,1) 100%)'">
                      <span class="slider-percent" x-text="Math.round(light.brightness / 254 * 100) + '%'"></span>
                    </div>
                  </div>

                  <!-- Color Temperature Slider -->
                  <div class="light-control" x-show="light.state === 'ON' && light.available" x-transition
                       :class="{ 'control-disabled': !$store.mqtt.connected || $store.lights.initializing || light.syncing }">
                    <div class="control-row">
                      <label class="control-label">
                        <span class="control-icon">üå°Ô∏è</span>
                        Color Temp
                      </label>
                      <span class="control-value">
                        <span x-show="light.syncing" class="control-syncing">‚ü≥</span>
                        <span x-text="getColorTempLabel(light.colorTemp)"></span>
                      </span>
                    </div>
                    <input type="range" class="slider colortemp-slider" min="250" max="454"
                           x-model="light.colorTemp"
                           :disabled="!$store.mqtt.connected || $store.lights.initializing"
                           @change="$store.lights.setColorTemp(light, $event.target.value)">
                    <div class="colortemp-labels">
                      <span>Cool</span>
                      <span>Warm</span>
                    </div>
                  </div>

                  <!-- Quick Presets -->
                  <div class="light-presets" x-show="light.state === 'ON' && light.available" x-transition>
                    <button class="preset-btn" @click="$store.lights.applyPreset(light, 'reading')" title="Reading">üìñ</button>
                    <button class="preset-btn" @click="$store.lights.applyPreset(light, 'relax')" title="Relax">üåÖ</button>
                    <button class="preset-btn" @click="$store.lights.applyPreset(light, 'bright')" title="Bright">‚òÄÔ∏è</button>
                    <button class="preset-btn" @click="$store.lights.applyPreset(light, 'night')" title="Night">üåô</button>
                  </div>

                  <!-- Link Quality -->
                  <div class="light-meta">
                    <span class="light-availability" :class="{ 'available': light.available, 'unavailable': !light.available }">
                      <span x-text="light.available ? 'üü¢' : 'üî¥'"></span>
                      <span x-text="light.available ? 'Online' : 'Offline'"></span>
                    </span>
                    <span class="light-linkquality" x-show="light.available" :title="'Link Quality: ' + light.linkquality">
                      üì∂ <span x-text="light.linkquality || '--'"></span>
                    </span>
                    <span class="light-update" x-text="formatLastUpdate(light.lastSeen)"></span>
                  </div>
                </div>
              </template>
            </div>

            <!-- Scene Buttons -->
            <div class="lights-scenes" :class="{ 'lights-disabled': !$store.mqtt.connected || $store.lights.initializing }">
              <h3 class="scenes-title">Quick Scenes</h3>
              <div class="scenes-grid">
                <button class="scene-btn" @click="$store.lights.applyScene('movie')">
                  <span class="scene-icon">üé¨</span>
                  <span class="scene-name">Movie</span>
                </button>
                <button class="scene-btn" @click="$store.lights.applyScene('work')">
                  <span class="scene-icon">üíº</span>
                  <span class="scene-name">Work</span>
                </button>
                <button class="scene-btn" @click="$store.lights.applyScene('evening')">
                  <span class="scene-icon">üåÜ</span>
                  <span class="scene-name">Evening</span>
                </button>
                <button class="scene-btn" @click="$store.lights.applyScene('goodnight')">
                  <span class="scene-icon">üò¥</span>
                  <span class="scene-name">Goodnight</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Vision 8: 3D Floor Plan -->
        <div x-show="currentView === '3d'" x-cloak x-data="threeDView()" x-init="init()">
          <div class="three-d-view">
            <!-- Controls -->
            <div class="three-controls">
              <div class="view-toggle">
                <button class="btn btn-secondary" :class="{ active: viewMode === 'temperature' }"
                        @click="setViewMode('temperature')">üå°Ô∏è Temperature</button>
                <button class="btn btn-secondary" :class="{ active: viewMode === 'humidity' }"
                        @click="setViewMode('humidity')">üíß Humidity</button>
              </div>
            </div>

            <!-- Three.js Container -->
            <div class="three-container" x-ref="threeContainer"></div>

            <!-- View Control Buttons -->
            <div class="three-controls-bar">
              <button class="three-control-btn" :class="{ active: viewMode3D === '3d' }"
                      @click="set3DView()">
                üéÆ 3D View
              </button>
              <button class="three-control-btn" :class="{ active: viewMode3D === 'top' }"
                      @click="setTopView()">
                üìê Top View
              </button>
              <button class="three-control-btn" :class="{ active: !wallsVisible }"
                      @click="toggleWalls()">
                üß± <span x-text="wallsVisible ? 'Hide Walls' : 'Show Walls'"></span>
              </button>
              <button class="three-control-btn" :class="{ active: autoRotate }"
                      @click="toggleAutoRotate()">
                üîÑ <span x-text="autoRotate ? 'Stop' : 'Rotate'"></span>
              </button>
              <button class="three-control-btn" :class="{ active: darkTheme }"
                      @click="toggleDarkTheme()">
                üåô Dark
              </button>
              <div class="zoom-controls">
                <button class="three-control-btn zoom-btn" @click="zoomIn()">‚ûï</button>
                <button class="three-control-btn zoom-btn" @click="zoomOut()">‚ûñ</button>
              </div>
            </div>

            <!-- Legend -->
            <div class="three-legend">
              <div class="legend-title" x-text="viewMode === 'temperature' ? 'Temperature' : 'Humidity'"></div>
              <div class="legend-items">
                <template x-for="item in getLegendItems()" :key="item.label">
                  <div class="legend-item">
                    <div class="legend-color" :style="{ background: item.color }"></div>
                    <span class="legend-label" x-text="item.label"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- Tip -->
            <div class="three-tip">
              üè† Interactive 3D view of your home ‚Ä¢ Drag to rotate, scroll to zoom
            </div>
          </div>
        </div>

        <!-- Isometric Floor Plan View -->
        <div x-show="currentView === 'isometric'" x-cloak x-data="isometricView()" x-init="init()">
          <div class="isometric-view">
            <!-- Controls -->
            <div class="iso-controls">
              <div class="iso-view-toggle">
                <button class="iso-control-btn" :class="{ active: viewMode === 'temperature' }"
                        @click="setViewMode('temperature')">üå°Ô∏è Temp</button>
                <button class="iso-control-btn" :class="{ active: viewMode === 'humidity' }"
                        @click="setViewMode('humidity')">üíß Humid</button>
              </div>
              <button class="iso-control-btn" :class="{ active: !wallsVisible }"
                      @click="toggleWalls()">
                üß± <span x-text="wallsVisible ? 'Hide Walls' : 'Show Walls'"></span>
              </button>
              <button class="iso-control-btn" :class="{ active: darkTheme }"
                      @click="toggleDarkTheme()">
                üåô Dark
              </button>
              <button class="iso-control-btn" :class="{ active: autoRotate }"
                      @click="toggleAutoRotate()">
                üîÑ <span x-text="autoRotate ? 'Stop' : 'Rotate'"></span>
              </button>
              <button class="iso-control-btn" @click="resetView()">
                üéØ Reset
              </button>
              <div class="iso-zoom-controls">
                <button class="iso-control-btn iso-zoom-btn" @click="zoomOut()">‚ûñ</button>
                <span class="iso-zoom-indicator" x-text="getZoomPercent() + '%'"></span>
                <button class="iso-control-btn iso-zoom-btn" @click="zoomIn()">‚ûï</button>
              </div>
            </div>

            <!-- Isometric Canvas Container -->
            <div class="iso-container" x-ref="isoContainer"></div>

            <!-- Legend -->
            <div class="iso-legend">
              <span class="iso-legend-label" x-text="viewMode === 'temperature' ? 'Cold' : 'Dry'"></span>
              <div class="iso-legend-gradient" :class="{ humidity: viewMode === 'humidity' }"></div>
              <span class="iso-legend-label" x-text="viewMode === 'temperature' ? 'Hot' : 'Humid'"></span>
            </div>

            <!-- Tip -->
            <div class="iso-tip">
              üî∑ Isometric view ‚Ä¢ Drag to pan, scroll to zoom ‚Ä¢ Press I for quick access
            </div>
          </div>
        </div>

        <!-- Vision 9: Sensor Configuration -->
        <div x-show="currentView === 'config'" x-cloak x-data="sensorConfigView()" x-init="init()">
          <div class="sensor-config-container">
            <!-- Sensor Palette (Left Panel) -->
            <div class="sensor-palette">
              <div class="palette-header">
                <span class="palette-title">‚öôÔ∏è Sensors</span>
                <span class="palette-count" x-text="placedCount + '/' + totalCount + ' placed'"></span>
              </div>

              <!-- Search Box -->
              <div class="palette-search">
                <input type="text" placeholder="üîç Search sensors..." x-model="searchQuery">
              </div>

              <!-- Loading State -->
              <div class="palette-loading" x-show="loading">
                <div class="loading-spinner"></div>
                <span>Discovering sensors...</span>
              </div>

              <!-- Empty State -->
              <div class="palette-empty" x-show="!loading && totalCount === 0">
                <span class="empty-icon">üì°</span>
                <span>No sensors found</span>
                <span>Check MQTT connection</span>
              </div>

              <!-- Sensor Groups by Type -->
              <template x-for="(typeSensors, sensorType) in sensorsByType" :key="sensorType">
                <div class="sensor-type-group" x-show="typeSensors.length > 0">
                  <div class="type-header" @click="expandedTypes[sensorType] = !expandedTypes[sensorType]">
                    <span class="type-icon" x-text="getTypeIcon(sensorType)"></span>
                    <span class="type-label" x-text="getTypeLabel(sensorType)"></span>
                    <span class="type-count" x-text="typeSensors.length"></span>
                  </div>
                  <div class="sensor-list" x-show="expandedTypes[sensorType]">
                    <template x-for="sensor in typeSensors" :key="sensor.ieee_address">
                      <div class="sensor-card"
                           :class="{
                             placed: isPlaced(sensor.ieee_address),
                             selected: selectedSensor?.ieee_address === sensor.ieee_address,
                             stale: isStale(sensor.ieee_address)
                           }"
                           draggable="true"
                           @dragstart="startDrag($event, sensor)"
                           @click="selectSensor(sensor)">
                        <div class="sensor-icon"
                             :style="'background-color: ' + getTypeColor(sensor.sensorType)">
                          <span x-text="getTypeIcon(sensor.sensorType)"></span>
                        </div>
                        <div class="sensor-info">
                          <div class="sensor-name" x-text="sensor.friendly_name"></div>
                          <div class="sensor-value" x-text="formatLiveValue(sensor)"></div>
                          <div class="sensor-status">
                            <span class="placed-badge" x-show="isPlaced(sensor.ieee_address)">‚úì Placed</span>
                            <span class="unplaced-badge" x-show="!isPlaced(sensor.ieee_address)">‚óã Unplaced</span>
                            <span class="stale-badge" x-show="isStale(sensor.ieee_address)">‚ö† Stale</span>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>

              <!-- Coverage Toggle -->
              <label class="coverage-toggle" x-show="hasCoverageToggle">
                <input type="checkbox" x-model="showCoverage">
                <span>Show motion coverage zones</span>
              </label>
            </div>

            <!-- 3D Canvas -->
            <div class="config-canvas"
                 x-ref="configCanvas"
                 @dragover.prevent="onDragOver($event)"
                 @drop.prevent="onDrop($event)">

              <!-- Control Buttons -->
              <div class="config-controls">
                <button class="control-btn" @click="resetView()" title="Reset View">üîÑ</button>
                <button class="control-btn" @click="toggleTopView()" :class="{ active: isTopView }" title="Top View">üìê</button>
                <button class="control-btn" @click="zoomIn()" title="Zoom In">‚ûï</button>
                <button class="control-btn" @click="zoomOut()" title="Zoom Out">‚ûñ</button>
              </div>

              <!-- Tooltip -->
              <div class="config-tooltip"
                   x-show="tooltip.visible"
                   :style="'left: ' + tooltip.x + 'px; top: ' + tooltip.y + 'px'"
                   x-text="tooltip.text">
              </div>
            </div>

            <!-- Status Bar -->
            <div class="config-status">
              <div class="status-item">
                <span class="status-label">Placed:</span>
                <span class="status-value" x-text="placedCount + '/' + totalCount"></span>
              </div>
              <div class="status-divider"></div>
              <div class="status-item" x-show="selectedSensor">
                <span class="status-label">Selected:</span>
                <span class="status-value" x-text="selectedSensor?.friendly_name || 'None'"></span>
              </div>
              <div class="status-divider" x-show="selectedSensor && selectedRoom"></div>
              <div class="status-item" x-show="selectedRoom">
                <span class="status-label">Room:</span>
                <span class="status-value" x-text="selectedRoom || '-'"></span>
              </div>
              <div style="flex: 1;"></div>
              <button class="reset-btn" @click="resetAllPositions()" title="Remove all sensor placements">
                üóëÔ∏è Reset All
              </button>
              <button class="help-btn" @click="showHelp = !showHelp" title="Help">‚ùì</button>
            </div>
          </div>
        </div>

        <!-- Vision 10: CO2 Monitor -->
        <div x-show="currentView === 'co2'" x-cloak x-data="co2View()" x-init="init()">
          <div class="co2-view">

            <!-- Giant Circular Gauge -->
            <div class="co2-gauge-section">
              <div class="co2-gauge-header">AIR QUALITY</div>
              <div class="co2-gauge">
                <svg viewBox="0 0 200 200" class="co2-gauge-ring">
                  <circle cx="100" cy="100" r="90" class="co2-gauge-bg"/>
                  <circle cx="100" cy="100" r="90"
                          class="co2-gauge-arc"
                          :class="{ pulse: !isStale }"
                          :stroke="co2Color"
                          :stroke-dasharray="gaugeArc"
                          transform="rotate(-90 100 100)"/>
                </svg>
                <div class="co2-gauge-content">
                  <span class="co2-value" :style="{ color: co2Color }" x-text="co2Value ?? '--'"></span>
                  <span class="co2-unit">ppm</span>
                  <span class="co2-status" :style="{ color: co2Color }" x-text="airQualityLevel"></span>
                  <div class="co2-trend" :class="trendDirection" x-show="trendDirection !== 'stable'">
                    <span class="co2-trend-arrow" x-text="trendArrow"></span>
                    <span x-text="trendValue + ' ppm'"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Air Quality Dashboard (3 Cards) -->
            <div class="air-quality-dashboard">
              <!-- CO2 Card -->
              <div class="air-quality-card highlight">
                <div class="air-quality-icon">üí®</div>
                <div class="air-quality-label">CO2</div>
                <div class="air-quality-value" :style="{ color: co2Color }" x-text="(co2Value ?? '--') + ' ppm'"></div>
                <div class="air-quality-bar">
                  <div class="air-quality-fill" :style="{ width: co2Percent + '%', background: co2Color }"></div>
                </div>
                <div class="air-quality-status" x-text="airQualityLevel"></div>
              </div>

              <!-- Temperature Card -->
              <div class="air-quality-card">
                <div class="air-quality-icon">üå°Ô∏è</div>
                <div class="air-quality-label">Temperature</div>
                <div class="air-quality-value" :style="{ color: tempColor }" x-text="temperature !== null ? temperature.toFixed(1) + '¬∞C' : '--'"></div>
                <div class="air-quality-bar">
                  <div class="air-quality-fill" :style="{ width: tempPercent + '%', background: tempColor }"></div>
                </div>
                <div class="air-quality-status" x-text="tempLevel"></div>
              </div>

              <!-- Humidity Card -->
              <div class="air-quality-card">
                <div class="air-quality-icon">üíß</div>
                <div class="air-quality-label">Humidity</div>
                <div class="air-quality-value" :style="{ color: humidityColor }" x-text="humidity !== null ? Math.round(humidity) + '%' : '--'"></div>
                <div class="air-quality-bar">
                  <div class="air-quality-fill" :style="{ width: humidityPercent + '%', background: humidityColor }"></div>
                </div>
                <div class="air-quality-status" x-text="humidityLevel"></div>
              </div>
            </div>

            <!-- History Chart -->
            <div class="co2-chart-section">
              <div class="chart-header">
                <div class="chart-title">CO2 History</div>
                <div class="time-range-selector">
                  <template x-for="range in timeRanges" :key="range">
                    <button class="time-range-btn"
                            :class="{ active: timeRange === range }"
                            @click="setTimeRange(range)"
                            x-text="range"></button>
                  </template>
                </div>
              </div>

              <div class="co2-chart-container">
                <div class="chart-loading" x-show="loading">
                  <span class="loading-indicator"></span>
                  Loading history...
                </div>
                <div class="chart-no-data" x-show="!loading && co2History.length === 0">
                  No data in this time range
                </div>
                <svg id="co2-history-chart" class="co2-chart" x-show="!loading && co2History.length > 0"></svg>
              </div>

              <!-- Chart Stats -->
              <div class="chart-stats" x-show="co2History.length > 0">
                <div class="chart-stat">
                  <div class="chart-stat-label">Min</div>
                  <div class="chart-stat-value" x-text="minMax.min + ' ppm'"></div>
                </div>
                <div class="chart-stat">
                  <div class="chart-stat-label">Avg</div>
                  <div class="chart-stat-value" x-text="avgCo2 + ' ppm'"></div>
                </div>
                <div class="chart-stat">
                  <div class="chart-stat-label">Max</div>
                  <div class="chart-stat-value" x-text="minMax.max + ' ppm'"></div>
                </div>
              </div>
            </div>

            <!-- Legend -->
            <div class="co2-legend">
              <div class="legend-item">
                <div class="legend-dot" style="background: #34C759;"></div>
                <span>Excellent (&lt;600)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background: #30D158;"></div>
                <span>Good (600-1000)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background: #FFD60A;"></div>
                <span>Moderate (1000-1500)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background: #FF9500;"></div>
                <span>Poor (1500-2000)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background: #FF3B30;"></div>
                <span>Bad (&gt;2000)</span>
              </div>
            </div>

            <!-- Footer -->
            <div class="co2-footer">
              <div class="co2-footer-item" :class="{ 'stale-indicator': isStale }">
                <span x-text="isStale ? '‚ö†Ô∏è' : '‚úì'"></span>
                <span x-text="'Last update: ' + formatLastUpdate()"></span>
              </div>
              <div class="co2-footer-item">
                <span>üìç</span>
                <span x-text="sensorRoom"></span>
              </div>
              <div class="co2-footer-item" x-show="co2History.length > 0">
                <span>üìä</span>
                <span x-text="co2History.length + ' readings'"></span>
              </div>
            </div>

            <!-- Ambient Mode Toggle Button -->
            <button class="ambient-toggle" @click="toggleAmbient()">
              üåô Ambient Mode
            </button>

            <!-- Ambient Mode Overlay -->
            <div class="co2-ambient-overlay" :class="{ hidden: !ambientMode }" @click="ambientMode = false">
              <div class="ambient-co2-value" :style="{ color: co2Color }" x-text="co2Value ?? '--'"></div>
              <div class="ambient-co2-unit">ppm</div>
              <div class="ambient-status" :style="{ color: co2Color }" x-text="airQualityLevel"></div>
              <div class="ambient-trend" x-text="trendArrow"></div>
              <div class="ambient-room" x-text="sensorRoom"></div>
              <div class="ambient-hint">Tap anywhere to exit</div>
            </div>

          </div>
        </div>

        <!-- Zigbee Network View -->
        <div x-show="currentView === 'network'" x-cloak x-data="networkView()" x-init="init()">
          <div class="network-view">
            <!-- Controls -->
            <div class="network-controls">
              <button class="network-control-btn" :class="{ active: showSignalRange }"
                      @click="showSignalRange = !showSignalRange">
                üì∂ <span x-text="showSignalRange ? 'Hide Range' : 'Show Range'"></span>
              </button>
              <button class="network-control-btn" :class="{ active: showLabels }"
                      @click="showLabels = !showLabels">
                üè∑Ô∏è <span x-text="showLabels ? 'Hide Labels' : 'Show Labels'"></span>
              </button>
              <button class="network-control-btn" :class="{ active: autoRotate }"
                      @click="toggleAutoRotate()">
                üîÑ <span x-text="autoRotate ? 'Stop' : 'Rotate'"></span>
              </button>
              <button class="network-control-btn" :class="{ active: showWallNumbers }"
                      @click="toggleWallNumbers()">
                üî¢ <span x-text="showWallNumbers ? 'Hide #' : 'Show #'"></span>
              </button>
              <button class="network-control-btn" @click="resetView()">
                üéØ Reset
              </button>
              <div class="network-zoom-controls">
                <button class="network-control-btn network-zoom-btn" @click="zoomOut()">‚ûñ</button>
                <span class="network-zoom-indicator" x-text="getZoomPercent() + '%'"></span>
                <button class="network-control-btn network-zoom-btn" @click="zoomIn()">‚ûï</button>
              </div>
            </div>

            <!-- Network Canvas Container -->
            <div class="network-container" x-ref="networkContainer"></div>

            <!-- Legend -->
            <div class="network-legend">
              <div class="legend-item">
                <div class="legend-badge coordinator">Z</div>
                <span>Zigbee Coordinator</span>
              </div>
              <div class="legend-item">
                <div class="legend-badge router">R</div>
                <span>Zigbee Router</span>
              </div>
              <div class="legend-item">
                <div class="legend-badge end-device">E</div>
                <span>Zigbee End Device</span>
              </div>
            </div>

            <!-- Stats -->
            <div class="network-stats">
              <div class="network-stat">
                <span>üì°</span>
                <span x-text="deviceCount + ' devices'"></span>
              </div>
              <div class="network-stat">
                <span>üîó</span>
                <span x-text="routerCount + ' routers'"></span>
              </div>
              <div class="network-stat">
                <span>üìç</span>
                <span x-text="endDeviceCount + ' end devices'"></span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer" x-show="currentView !== 'ambient'">
      <span class="footer-status">
        <span class="loading-indicator" x-show="$store.mqtt.connecting"></span>
        <span class="status-dot" :class="{ 'connected': $store.mqtt.connected, 'disconnected': !$store.mqtt.connected }" x-show="!$store.mqtt.connecting"></span>
        <span x-text="$store.mqtt.connecting ? 'Connecting...' : ($store.mqtt.connected ? 'Connected' : 'Reconnecting...')"></span>
      </span>
      <span> ‚Ä¢ </span>
      <span x-show="$store.rooms.loading" class="footer-status">
        <span class="loading-indicator"></span>
        <span>Loading history...</span>
      </span>
      <span x-show="!$store.rooms.loading" x-text="$store.rooms.historyCount + ' data points'"></span>
      <span x-show="$store.lights.syncing"> ‚Ä¢ <span class="loading-indicator"></span> Syncing lights...</span>
    </footer>

    <!-- Room Detail Modal -->
    <template x-if="$store.roomDetail.selectedRoom">
      <div class="modal-overlay" @click.self="$store.roomDetail.close()" @keydown.escape.window="$store.roomDetail.close()">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">
              <span class="icon" x-text="$store.roomDetail.selectedRoom.icon"></span>
              <h2 x-text="$store.roomDetail.selectedRoom.name"></h2>
            </div>
            <button class="modal-close" @click="$store.roomDetail.close()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="time-range-selector">
              <template x-for="range in $store.roomDetail.timeRanges" :key="range">
                <button class="btn btn-secondary" :class="{ active: $store.roomDetail.timeRange === range }"
                        @click="$store.roomDetail.setTimeRange(range)" x-text="range"></button>
              </template>
              <span x-show="$store.roomDetail.loading" class="loading-indicator"></span>
            </div>

            <div class="modal-stats">
              <div class="modal-stat">
                <div class="modal-stat-label">Temperature</div>
                <div class="modal-stat-value temp"
                     x-text="$store.roomDetail.selectedRoom.temperature !== null
                       ? $store.roomDetail.selectedRoom.temperature.toFixed(1) + '¬∞C' : '--'"></div>
              </div>
              <div class="modal-stat">
                <div class="modal-stat-label">Humidity</div>
                <div class="modal-stat-value humid"
                     x-text="$store.roomDetail.selectedRoom.humidity !== null
                       ? $store.roomDetail.selectedRoom.humidity.toFixed(0) + '%' : '--'"></div>
              </div>
              <div class="modal-stat">
                <div class="modal-stat-label">Min / Max</div>
                <div class="modal-stat-value minmax" x-text="$store.roomDetail.getMinMax()"></div>
              </div>
            </div>

            <div class="modal-chart">
              <div class="modal-chart-title" x-text="'Temperature History (last ' + $store.roomDetail.timeRange + ')'"></div>
              <div class="chart-temp">
                <template x-if="$store.roomDetail.tempHistory.length === 0 && !$store.roomDetail.loading">
                  <div class="no-data-message">No data in this time range</div>
                </template>
                <svg id="modal-chart-temp" x-show="$store.roomDetail.tempHistory.length > 0"></svg>
              </div>
            </div>

            <div class="modal-chart">
              <div class="modal-chart-title" x-text="'Humidity History (last ' + $store.roomDetail.timeRange + ')'"></div>
              <div class="chart-humid">
                <template x-if="$store.roomDetail.humidHistory.length === 0 && !$store.roomDetail.loading">
                  <div class="no-data-message">No data in this time range</div>
                </template>
                <svg id="modal-chart-humid" x-show="$store.roomDetail.humidHistory.length > 0"></svg>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <span x-text="'Last updated: ' + $store.roomDetail.formatUpdate($store.roomDetail.selectedRoom.lastSeen)"></span>
            <span> ‚Ä¢ </span>
            <span x-text="$store.roomDetail.tempHistory.length + ' temperature readings, ' + $store.roomDetail.humidHistory.length + ' humidity readings'"></span>
          </div>
        </div>
      </div>
    </template>

  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Stub for co2View - provides initial state and reactive getters -->
  <script>
    window.co2View = function() {
      return {
        // CO2 Thresholds (ppm)
        thresholds: { excellent: 600, good: 1000, moderate: 1500, poor: 2000 },

        // State
        timeRange: '6h',
        timeRanges: ['15m', '30m', '1h', '3h', '6h', '12h', '24h', '3d', '7d'],
        loading: false,
        co2History: [],
        tempHistory: [],
        humidHistory: [],
        trendDirection: 'stable',
        trendValue: 0,
        ambientMode: false,
        _moduleLoaded: false,

        // Reactive getters that access the store directly
        get co2Sensor() {
          const sensors = this.$store?.sensors;
          if (!sensors?.devices) return null;
          return sensors.devices.find(d =>
            d.friendly_name?.toLowerCase().includes('co2') && d.sensorType === 'co2'
          );
        },
        get liveData() {
          if (!this.co2Sensor) return null;
          return this.$store?.sensors?.getLiveData?.(this.co2Sensor.ieee_address) ?? null;
        },
        get co2Value() { return this.liveData?.co2 ?? null; },
        get temperature() { return this.liveData?.temperature ?? null; },
        get humidity() { return this.liveData?.humidity ?? null; },
        get airQualityLevel() {
          const co2 = this.co2Value;
          if (co2 === null) return 'unknown';
          if (co2 < this.thresholds.excellent) return 'excellent';
          if (co2 < this.thresholds.good) return 'good';
          if (co2 < this.thresholds.moderate) return 'moderate';
          if (co2 < this.thresholds.poor) return 'poor';
          return 'bad';
        },
        get co2Color() {
          const colors = { excellent: '#34C759', good: '#30D158', moderate: '#FFD60A', poor: '#FF9500', bad: '#FF3B30', unknown: '#AEAEB2' };
          return colors[this.airQualityLevel];
        },
        get gaugeArc() {
          const maxPPM = 2500;
          const value = Math.min(this.co2Value || 0, maxPPM);
          const percent = value / maxPPM;
          const circumference = 2 * Math.PI * 90;
          return `${percent * circumference} ${circumference}`;
        },
        get tempLevel() {
          const temp = this.temperature;
          if (temp === null) return 'unknown';
          if (temp < 18) return 'cold';
          if (temp < 20) return 'cool';
          if (temp <= 26) return 'comfortable';
          if (temp <= 28) return 'warm';
          return 'hot';
        },
        get tempColor() {
          const colors = { cold: '#90CAF9', cool: '#A5D6A7', comfortable: '#81C784', warm: '#FFE082', hot: '#EF5350', unknown: '#AEAEB2' };
          return colors[this.tempLevel];
        },
        get humidityLevel() {
          const h = this.humidity;
          if (h === null) return 'unknown';
          if (h < 30) return 'dry';
          if (h < 40) return 'low';
          if (h <= 60) return 'optimal';
          if (h <= 70) return 'high';
          return 'humid';
        },
        get humidityColor() {
          const colors = { dry: '#FFCC80', low: '#A5D6A7', optimal: '#81C784', high: '#90CAF9', humid: '#5C6BC0', unknown: '#AEAEB2' };
          return colors[this.humidityLevel];
        },
        get isStale() {
          if (!this.co2Sensor) return true;
          return this.$store?.sensors?.isStale?.(this.co2Sensor.ieee_address) ?? true;
        },
        get trendArrow() {
          if (this.trendDirection === 'rising') return '\u2191';
          if (this.trendDirection === 'falling') return '\u2193';
          return '\u2192';
        },
        get sensorRoom() {
          if (!this.co2Sensor) return 'Unknown';
          const name = this.co2Sensor.friendly_name || '';
          const match = name.match(/\[([^\]]+)\]/);
          return match ? match[1] + ' Room' : 'Room';
        },
        get minMax() {
          if (this.co2History.length === 0) return { min: '--', max: '--' };
          const values = this.co2History.map(d => d.value);
          return { min: Math.round(Math.min(...values)), max: Math.round(Math.max(...values)) };
        },
        get avgCo2() {
          if (this.co2History.length === 0) return '--';
          const sum = this.co2History.reduce((acc, d) => acc + d.value, 0);
          return Math.round(sum / this.co2History.length);
        },
        get co2Percent() { return Math.min(100, ((this.co2Value || 0) / 2500) * 100); },
        get tempPercent() { return Math.min(100, Math.max(0, ((this.temperature || 20) - 15) / 20 * 100)); },
        get humidityPercent() { return Math.min(100, Math.max(0, this.humidity || 0)); },

        // Methods
        init() {
          console.log('[co2-view] Stub initialized, waiting for module...');
          window._co2ViewComponent = this;
          this._checkForModule();
        },

        _checkForModule() {
          if (window._co2ViewMethods && !this._moduleLoaded) {
            console.log('[co2-view] Module methods available, enhancing...');
            this._moduleLoaded = true;
            // Only copy methods, not getters (getters are already defined above)
            const methods = window._co2ViewMethods;
            if (methods.loadHistoricalData) this.loadHistoricalData = methods.loadHistoricalData.bind(this);
            if (methods.queryInflux) this.queryInflux = methods.queryInflux.bind(this);
            if (methods.setTimeRange) this.setTimeRange = methods.setTimeRange.bind(this);
            if (methods.drawChart) this.drawChart = methods.drawChart.bind(this);
            if (methods.drawThresholdZones) this.drawThresholdZones = methods.drawThresholdZones.bind(this);
            if (methods.formatTimeLabel) this.formatTimeLabel = methods.formatTimeLabel.bind(this);
            if (methods.calculateTrend) this.calculateTrend = methods.calculateTrend.bind(this);
            if (methods.formatLastUpdate) this.formatLastUpdate = methods.formatLastUpdate.bind(this);
            // Load historical data now
            this.loadHistoricalData();
          } else if (!this._moduleLoaded) {
            setTimeout(() => this._checkForModule(), 100);
          }
        },

        loadHistoricalData() { console.log('[co2-view] Stub loadHistoricalData (waiting for module)'); },
        setTimeRange(range) { this.timeRange = range; },
        drawChart() {},
        calculateTrend() {},
        formatLastUpdate() { return 'No data'; },
        toggleAmbient() { this.ambientMode = !this.ambientMode; },
        destroy() {}
      };
    };
  </script>

  <!-- Stub for sensorConfigView - reactive stub that pulls from Alpine store -->
  <script>
    window.sensorConfigView = function() {
      return {
        searchQuery: '',
        expandedTypes: { climate: true, co2: true, motion: true, contact: true },
        showHelp: false,
        isTopView: false,
        showCoverage: false,
        tooltip: { text: '', visible: false, x: 0, y: 0 },
        selectedSensor: null,

        init() {
          console.log('[sensor-config] Stub initialized, waiting for Three.js module...');
          // Store reference for module to find and enhance
          window._sensorConfigComponent = this;
          this._checkForThreeJS();
        },

        _checkForThreeJS() {
          if (window._initSensorConfigThreeJS) {
            console.log('[sensor-config] Three.js module ready, initializing 3D view...');
            window._initSensorConfigThreeJS(this);
          } else {
            // Keep checking until module loads
            setTimeout(() => this._checkForThreeJS(), 100);
          }
        },

        // Reactive getters that pull from sensors store
        get loading() { return Alpine.store('sensors')?.loading ?? true; },
        get placedCount() { return Alpine.store('sensors')?.placedCount ?? 0; },
        get totalCount() { return Alpine.store('sensors')?.totalCount ?? 0; },
        get sensors() { return Alpine.store('sensors')?.devices ?? []; },
        get positions() { return Alpine.store('sensors')?.positions ?? {}; },
        get selectedRoom() {
          if (!this.selectedSensor) return null;
          return Alpine.store('sensors')?.getPosition(this.selectedSensor.ieee_address)?.roomId || null;
        },
        get hasCoverageToggle() {
          return this.sensors.some(s => s.sensorType === 'motion');
        },
        get sensorsByType() {
          const sensors = this.sensors;
          const grouped = { climate: [], co2: [], motion: [], contact: [] };
          sensors.forEach(sensor => {
            const type = sensor.sensorType || 'climate';
            if (grouped[type]) {
              if (!this.searchQuery ||
                  sensor.friendly_name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                  type.includes(this.searchQuery.toLowerCase())) {
                grouped[type].push(sensor);
              }
            }
          });
          return grouped;
        },

        // Helper methods
        getTypeIcon(type) { return { climate: 'üå°Ô∏è', co2: 'üí®', motion: 'üëÅÔ∏è', contact: 'üö™' }[type] || 'üì°'; },
        getTypeLabel(type) { return { climate: 'Temperature & Humidity', co2: 'CO‚ÇÇ Sensors', motion: 'Motion Sensors', contact: 'Contact Sensors' }[type] || 'Unknown'; },
        getTypeColor(type) { return { climate: '#34d399', co2: '#ff6b6b', motion: '#ffd93d', contact: '#38bdf8' }[type] || '#888'; },

        formatLiveValue(sensor) {
          const data = Alpine.store('sensors')?.getLiveData(sensor.ieee_address);
          if (!data) return '--';
          switch (sensor.sensorType) {
            case 'climate':
              const temp = data.temperature !== undefined ? `${data.temperature.toFixed(1)}¬∞` : '--';
              const hum = data.humidity !== undefined ? `${Math.round(data.humidity)}%` : '';
              return `${temp} ${hum}`.trim();
            case 'co2': return data.co2 !== undefined ? `${data.co2} ppm` : '--';
            case 'motion': return data.occupancy !== undefined ? (data.occupancy ? 'üî¥ Motion' : '‚ö™ Clear') : '--';
            case 'contact': return data.contact !== undefined ? (data.contact ? 'üîí Closed' : 'üîì Open') : '--';
            default: return '--';
          }
        },
        isPlaced(ieee) { return Alpine.store('sensors')?.isPlaced(ieee) || false; },
        isStale(ieee) { return Alpine.store('sensors')?.isStale(ieee) || false; },

        selectSensor(sensor) {
          this.selectedSensor = this.selectedSensor?.ieee_address === sensor.ieee_address ? null : sensor;
          if (window._sensorConfigController) {
            window._sensorConfigController.selectedSensor = this.selectedSensor?.ieee_address;
          }
        },
        startDrag(e, sensor) {
          e.dataTransfer?.setData('sensor-ieee', sensor.ieee_address);
          this.selectedSensor = sensor;
          // Start drag in Three.js controller
          if (window._sensorConfigController?.startDragFromPalette) {
            window._sensorConfigController.startDragFromPalette(sensor.ieee_address);
          }
        },
        onDragOver(e) {
          e.preventDefault();
          // Check if dragging a sensor
          if (!e.dataTransfer?.types?.includes('sensor-ieee')) return;

          const controller = window._sensorConfigController;
          const container = e.currentTarget;
          if (!controller || !container) return;

          // Calculate normalized mouse position
          const rect = container.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
          const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

          // Update preview position
          if (controller.updateDragPreview) {
            controller.updateDragPreview(x, y);
          }
        },
        onDragLeave(e) {
          // Hide preview when leaving canvas
          const threeState = window._configThreeState;
          if (threeState?.dragPreview) {
            threeState.dragPreview.visible = false;
          }
        },
        onDrop(e) {
          e.preventDefault();
          const ieee = e.dataTransfer?.getData('sensor-ieee');
          if (!ieee) return;

          const controller = window._sensorConfigController;
          const container = e.currentTarget;
          if (!controller || !container) return;

          // Calculate normalized mouse position for raycasting
          const rect = container.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
          const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

          // Use controller to handle the drop
          if (controller.handlePaletteDrop) {
            controller.handlePaletteDrop(ieee, x, y);
          }
        },
        resetView() {
          if (window._sensorConfigController?.onResize) {
            window._sensorConfigController.onResize();
          }
        },
        toggleTopView() {
          this.isTopView = !this.isTopView;
          // Could adjust camera angle via controller
        },
        zoomIn() {
          // Zoom via Three.js camera if available
          console.log('[stub] zoomIn');
        },
        zoomOut() {
          console.log('[stub] zoomOut');
        },
        resetAllPositions() { Alpine.store('sensors')?.resetAllPositions(); },
        toggleCoverage() {
          this.showCoverage = !this.showCoverage;
          if (window._sensorConfigController?.toggleCoverage) {
            window._sensorConfigController.toggleCoverage();
          }
        }
      };
    };
  </script>

  <!-- Alpine.js is now imported as ES module in js/app.js -->

  <!-- CO2 Monitor Module - enhances the stub with methods -->
  <script type="module">
    import { co2View } from './views/co2-monitor.js?v=3';

    // Get the module object and extract only the methods (not getters)
    const moduleObj = co2View();
    window._co2ViewMethods = {
      loadHistoricalData: moduleObj.loadHistoricalData,
      queryInflux: moduleObj.queryInflux,
      setTimeRange: moduleObj.setTimeRange,
      drawChart: moduleObj.drawChart,
      drawThresholdZones: moduleObj.drawThresholdZones,
      formatTimeLabel: moduleObj.formatTimeLabel,
      calculateTrend: moduleObj.calculateTrend,
      formatLastUpdate: moduleObj.formatLastUpdate
    };
    console.log('[co2-monitor] Module loaded, methods ready');

    // If stub component exists, trigger enhancement
    if (window._co2ViewComponent && !window._co2ViewComponent._moduleLoaded) {
      console.log('[co2-monitor] Stub found, enhancing with methods...');
      window._co2ViewComponent._checkForModule();
    }
  </script>

  <!-- Sensor Config Module - loads after Alpine, enhances the stub -->
  <script type="module">
    import { sensorConfigView } from './views/sensor-config.js?v=3';
    import { initSensorsStore } from './js/stores/sensors-store.js';
    import { FLOOR_PLAN_CONFIG, SENSOR_VISUALS } from './js/config.js';

    // Create a Three.js controller that will manage the 3D view
    // This is separate from Alpine's reactive system to avoid proxy issues
    const threeJSController = sensorConfigView(FLOOR_PLAN_CONFIG, SENSOR_VISUALS, THREE.OrbitControls);

    // Store controller globally for stub access
    window._sensorConfigThreeJS = threeJSController;

    // Expose initialization function for stub to call
    // Guard against multiple initializations
    let initializationComplete = false;

    window._initSensorConfigThreeJS = function(alpineComponent) {
      // Prevent multiple initializations
      if (initializationComplete) {
        console.log('[sensor-config] Already initialized, skipping');
        return;
      }
      console.log('[sensor-config] Initializing Three.js controller...');

      // The controller needs access to Alpine component for $refs
      const container = alpineComponent.$refs?.configCanvas;
      if (!container) {
        console.error('[sensor-config] Container ref not found, retrying...');
        setTimeout(() => window._initSensorConfigThreeJS(alpineComponent), 100);
        return;
      }

      // Create proxy object that gives controller access to container
      const controllerContext = {
        $refs: { configCanvas: container },
        tooltip: alpineComponent.tooltip,
        selectedSensor: null,
        showMotionCoverage: false
      };

      // Bind all controller methods to the proxy context
      Object.keys(threeJSController).forEach(key => {
        if (typeof threeJSController[key] === 'function') {
          controllerContext[key] = threeJSController[key].bind(controllerContext);
        }
      });

      // Store the bound controller for stub methods to use
      window._sensorConfigController = controllerContext;

      // Add custom drop handler for palette drops
      controllerContext.handlePaletteDrop = function(ieee, mouseX, mouseY) {
        const threeState = window._configThreeState;

        // Hide drag preview
        if (threeState?.dragPreview) {
          threeState.dragPreview.visible = false;
        }

        // Re-enable controls
        if (threeState?.controls) {
          threeState.controls.enabled = true;
        }

        if (!threeState?.raycaster || !threeState?.camera || !threeState?.floorPlane) {
          console.error('[sensor-config] Three.js state not ready for drop', {
            raycaster: !!threeState?.raycaster,
            camera: !!threeState?.camera,
            floorPlane: !!threeState?.floorPlane
          });
          return;
        }

        // Set mouse position for raycaster
        const mouse = new THREE.Vector2(mouseX, mouseY);
        threeState.raycaster.setFromCamera(mouse, threeState.camera);

        // Raycast to floor plane
        const intersects = threeState.raycaster.intersectObject(threeState.floorPlane);
        if (intersects.length === 0) {
          console.log('[sensor-config] Drop missed floor plane');
          return;
        }

        const point = intersects[0].point;
        const sensor = Alpine.store('sensors').getSensor(ieee);
        if (!sensor) {
          console.error('[sensor-config] Sensor not found:', ieee);
          return;
        }

        const visuals = window.SENSOR_VISUALS?.[sensor.sensorType] || window.SENSOR_VISUALS?.climate;
        const position = {
          x: point.x,
          y: visuals?.heightAboveFloor || 1.5,
          z: point.z
        };

        // Detect which room using bound detectRoom method
        const roomId = controllerContext.detectRoom ? controllerContext.detectRoom(point.x, point.z) : null;

        // Save position to store (persists via MQTT)
        Alpine.store('sensors').savePosition(ieee, position, roomId);
        console.log('[sensor-config] Sensor placed:', ieee, 'at', position, 'in', roomId);
      };

      // Update preview position during drag-over
      controllerContext.updateDragPreview = function(mouseX, mouseY) {
        const threeState = window._configThreeState;
        if (!threeState?.raycaster || !threeState?.camera || !threeState?.floorPlane) return;

        // Raycast to floor plane
        const mouse = new THREE.Vector2(mouseX, mouseY);
        threeState.raycaster.setFromCamera(mouse, threeState.camera);
        const intersects = threeState.raycaster.intersectObject(threeState.floorPlane);

        if (intersects.length === 0) {
          // Hide preview if not over floor
          if (threeState.dragPreview) threeState.dragPreview.visible = false;
          return;
        }

        const point = intersects[0].point;

        // Create preview sphere if not exists
        if (!threeState.dragPreview) {
          const geometry = new THREE.SphereGeometry(0.15, 16, 16);
          const material = new THREE.MeshBasicMaterial({
            color: 0x34d399,  // Green
            transparent: true,
            opacity: 0.8
          });
          threeState.dragPreview = new THREE.Mesh(geometry, material);
          threeState.scene.add(threeState.dragPreview);
        }

        // Update preview position
        threeState.dragPreview.visible = true;
        threeState.dragPreview.position.set(point.x, 1.5, point.z);

        // Color based on validity (green = valid room, red = invalid)
        const roomId = controllerContext.detectRoom ? controllerContext.detectRoom(point.x, point.z) : null;
        threeState.dragPreview.material.color.setHex(roomId ? 0x34d399 : 0xff6b6b);
      };

      // Custom initialization that waits for container to be visible
      function initThreeJS() {
        const c = container;
        if (!c || c.clientWidth === 0 || c.clientHeight === 0) {
          // Container not visible yet (view hidden), retry
          setTimeout(initThreeJS, 200);
          return;
        }

        console.log('[sensor-config] Container ready, initializing Three.js...');
        try {
          controllerContext.initScene();
          controllerContext.initCamera(c, THREE.OrbitControls);
          controllerContext.initRenderer(c);
          controllerContext.initLighting();
          controllerContext.initRaycaster();
          controllerContext.buildFloorPlan();
          controllerContext.setupEventListeners(c);
          controllerContext.animate();
          initializationComplete = true;
          console.log('[sensor-config] Three.js initialization complete!');
        } catch (e) {
          console.error('[sensor-config] Three.js init error:', e);
        }
      }

      initThreeJS();
    };
    console.log('[sensor-config] Module loaded, _initSensorConfigThreeJS ready');

    // Replace stub for any future component creations
    window.sensorConfigView = function() {
      return sensorConfigView(FLOOR_PLAN_CONFIG, SENSOR_VISUALS, THREE.OrbitControls);
    };

    // Initialize sensors store
    function initSensors() {
      const CONFIG = window.CONFIG;
      if (typeof Alpine !== 'undefined' && CONFIG) {
        if (!Alpine.store('sensors')) {
          initSensorsStore(Alpine, CONFIG);
          console.log('[sensor-config] Sensors store initialized');
        }
        // Initialize MQTT subscriptions
        setTimeout(() => {
          const sensorsStore = Alpine.store('sensors');
          if (sensorsStore && Alpine.store('mqtt')?.client) {
            sensorsStore.init();
            console.log('[sensor-config] Sensors MQTT subscriptions initialized');
          }
        }, 2000);
      }
    }

    // Try to initialize
    if (typeof Alpine !== 'undefined') {
      initSensors();
    } else {
      document.addEventListener('alpine:init', () => {
        initSensorsStore(Alpine, window.CONFIG);
      });
      document.addEventListener('DOMContentLoaded', initSensors);
    }
  </script>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const CONFIG = {
      mqttUrl: 'ws://' + window.location.hostname + ':9001',
      baseTopic: 'zigbee2mqtt',
      influxUrl: '/api/influx',
      influxDb: 'homeassistant',
      rooms: [
        { id: 'living', name: 'Living Room', icon: 'üõãÔ∏è', sensor: '[Living] Temperature & Humidity', entityId: 'sensor.living_temperature_humidity' },
        { id: 'bedroom', name: 'Bedroom', icon: 'üõèÔ∏è', sensor: '[Bed] Temperature & Humidity Sensor', entityId: 'sensor.bed_temperature_humidity_sensor' },
        { id: 'study', name: 'Study', icon: 'üìö', sensor: '[Study] Temperature & Humidity', entityId: 'sensor.study_temperature_humidity' },
        { id: 'kitchen', name: 'Kitchen', icon: 'üç≥', sensor: '[Kitchen] Temperature & Humidity', entityId: 'sensor.kitchen_temperature_humidity' },
        { id: 'bathroom', name: 'Bathroom', icon: 'üöø', sensor: '[Bath] Temperature & Humidity', entityId: 'sensor.bath_temperature_humidity' },
        { id: 'balcony', name: 'Balcony', icon: 'üåø', sensor: '[Balcony] Temperature & Humidity', entityId: 'sensor.balcony_temperature_humidity' }
      ],
      staleThreshold: 5 * 60 * 1000,
      maxHistoryPoints: 500,
      historyHours: 6
    };
    // Make CONFIG globally available for modules
    window.CONFIG = CONFIG;

    // Alpine stores and app() are now in js/app.js (imports from js/stores/*.js)
    // CONFIG is kept here for compatibility with inline view components

    // ========================================
    // VIEW COMPONENTS (to be extracted in Phase 4)
    // ========================================

    // Placeholder - stores removed, now provided by js/stores/*.js modules
    // Placeholder - app() removed, now provided by js/app.js
    // Placeholder - networkView removed, now provided by views/network.js
  </script>
</body>
</html>
