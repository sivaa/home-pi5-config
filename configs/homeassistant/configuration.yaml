homeassistant:
  name: Home
  unit_system: metric
  time_zone: Europe/Berlin
  internal_url: "http://pi:8123"
  external_url: "https://ha.sivaa.in"
  customize:
    media_player.broken_display:
      friendly_name: "Broken Display"

frontend:
config:
mobile_app:

http:
  server_port: 8123
  use_x_forwarded_for: true
  cors_allowed_origins:
    - http://localhost:8888
    - http://127.0.0.1:8888
    - http://pi:8888
  trusted_proxies:
    # Local/Docker
    - 127.0.0.1
    - ::1
    - 172.16.0.0/12
    # Cloudflare IPv4 ranges
    - 173.245.48.0/20
    - 103.21.244.0/22
    - 103.22.200.0/22
    - 103.31.4.0/22
    - 141.101.64.0/18
    - 108.162.192.0/18
    - 190.93.240.0/20
    - 188.114.96.0/20
    - 197.234.240.0/22
    - 198.41.128.0/17
    - 162.158.0.0/15
    - 104.16.0.0/13
    - 104.24.0.0/14
    - 172.64.0.0/13
    - 131.0.72.0/22
    # Cloudflare IPv6 ranges
    - 2400:cb00::/32
    - 2606:4700::/32
    - 2803:f800::/32
    - 2405:b500::/32
    - 2405:8100::/32
    - 2a06:98c0::/29
    - 2c0f:f248::/32

# MQTT - Configured via UI integration (Settings > Devices & Services > MQTT)
# VPN provides network security - no MQTT authentication needed
# broker: mosquitto, port: 1883 (anonymous access allowed)

# InfluxDB integration - writes sensor data directly
influxdb:
  host: influxdb
  port: 8086
  database: homeassistant
  default_measurement: state
  include:
    entity_globs:
      - sensor.*temperature*
      - sensor.*humidity*
      - sensor.*battery*
      - sensor.*co2*
      - sensor.*air_quality*
      - binary_sensor.hot_water_running
      - sensor.hot_water_*

# Recorder for local history
recorder:
  purge_keep_days: 7
  commit_interval: 60
  include:
    entity_globs:
      - sensor.*temperature*
      - sensor.*humidity*
      - sensor.*co2*
      - sensor.*air_quality*
      - media_player.*  # Track Cast device availability for TTS debugging
      - binary_sensor.hot_water_running
      - sensor.hot_water_*

logger:
  default: warning
  logs:
    homeassistant.components.influxdb: info
    homeassistant.components.google_assistant: info
    homeassistant.components.automation: info
    homeassistant.components.tts: info

# =============================================================================
# MEDIA SOURCE (Required for TTS)
# =============================================================================
media_source:

# =============================================================================
# TEXT-TO-SPEECH (TTS)
# Purpose: Voice announcements via Google Home speakers
# Docs: https://www.home-assistant.io/integrations/google_translate/
# =============================================================================
tts:
  - platform: google_translate
    language: 'en'

# =============================================================================
# GOOGLE ASSISTANT INTEGRATION
# Purpose: Voice control via Google Home devices
# Docs: https://www.home-assistant.io/integrations/google_assistant/
# =============================================================================
google_assistant:
  project_id: siva-home-assistant-1
  service_account: !include SERVICE_ACCOUNT.json
  report_state: true
  expose_by_default: false
  exposed_domains:
    - light
    - switch
    - sensor
    - climate
  entity_config:
    # === LIGHTS (Voice controllable) ===
    light.study_ikea_light:
      name: "Study Light"
      expose: true
      room: "Study"
      aliases:
        - "Office Light"
        - "Study Room Light"

    light.living_ikea_light:
      name: "Living Room Light"
      expose: true
      room: "Living Room"
      aliases:
        - "Lounge Light"
        - "Main Light"

    # === SMART PLUG (Voice controllable) ===
    switch.smart_plug_1:
      name: "Smart Plug"
      expose: true
      room: "Living Room"
      aliases:
        - "Plug"
        - "Power Plug"

    # === TEMPERATURE SENSORS (Read-only, queryable) ===
    sensor.study_temperature_humidity_temperature:
      name: "Study Temperature"
      expose: true
      room: "Study"

    sensor.living_temperature_humidity_temperature:
      name: "Living Room Temperature"
      expose: true
      room: "Living Room"

    sensor.bed_temperature_humidity_sensor_temperature:
      name: "Bedroom Temperature"
      expose: true
      room: "Bedroom"

    sensor.kitchen_temperature_humidity_temperature:
      name: "Kitchen Temperature"
      expose: true
      room: "Kitchen"

    sensor.bath_temperature_humidity_temperature:
      name: "Bathroom Temperature"
      expose: true
      room: "Bathroom"

    sensor.balcony_temperature_humidity_temperature:
      name: "Balcony Temperature"
      expose: true
      room: "Balcony"

    # === HUMIDITY SENSORS ===
    sensor.study_temperature_humidity_humidity:
      name: "Study Humidity"
      expose: true
      room: "Study"

    sensor.living_temperature_humidity_humidity:
      name: "Living Room Humidity"
      expose: true
      room: "Living Room"

    sensor.bed_temperature_humidity_sensor_humidity:
      name: "Bedroom Humidity"
      expose: true
      room: "Bedroom"

    # === CO2 SENSOR ===
    sensor.hallway_co2_co2:
      name: "Air Quality"
      expose: true
      room: "Hallway"
      aliases:
        - "CO2 Sensor"
        - "Air Quality Sensor"

    # === MOTION SENSOR (Mailbox) ===
    binary_sensor.mailbox_motion_sensor_occupancy:
      name: "Mailbox Sensor"
      expose: true
      room: "Entry"
      aliases:
        - "Mail Sensor"

    # === THERMOSTATS (Climate control) ===
    climate.study_thermostat:
      name: "Study Thermostat"
      expose: true
      room: "Study"
      aliases:
        - "Study Heater"
        - "Office Thermostat"

    climate.living_thermostat_inner:
      name: "Living Inner"
      expose: true
      room: "Living Room"
      aliases:
        - "Living Inner Thermostat"
        - "Living Inner Heater"

    climate.living_thermostat_outer:
      name: "Living Outer"
      expose: true
      room: "Living Room"
      aliases:
        - "Living Outer Thermostat"
        - "Living Outer Heater"

    climate.bed_thermostat:
      name: "Bedroom Thermostat"
      expose: true
      room: "Bedroom"
      aliases:
        - "Bedroom Heater"
        - "Bed Heater"

# =============================================================================
# WEATHER INTEGRATION
# Purpose: Official weather forecast for Zehlendorf, Berlin (used in dashboard header)
# Docs: https://www.home-assistant.io/integrations/met/
# =============================================================================
weather:
  - platform: met
    name: Zehlendorf Weather
    latitude: 52.4319
    longitude: 13.2599

# =============================================================================
# INPUT BOOLEANS - State Memory for Automations
# Purpose: Remember heater states before window-triggered shutoff
# =============================================================================
input_boolean:
  # NOTE: No 'initial:' - state preserved across HA restarts
  study_heater_was_on:
    name: Study Heater Was On
  living_inner_heater_was_on:
    name: Living Inner Heater Was On
  living_outer_heater_was_on:
    name: Living Outer Heater Was On
  bedroom_heater_was_on:
    name: Bedroom Heater Was On
  # Guard flag to prevent state overwrite when multiple windows open
  heaters_off_due_to_window:
    name: Heaters Off Due To Window
    icon: mdi:window-open-variant
  # Guard flag for CO2-triggered heater shutoff
  heaters_off_due_to_co2:
    name: Heaters Off Due To CO2
    icon: mdi:molecule-co2
  # Bedroom night mode flag (23:00-06:00 temperature limit)
  bedroom_night_mode_active:
    name: Bedroom Night Mode Active
    icon: mdi:weather-night

# =============================================================================
# INPUT NUMBERS - Saved Setpoints for Temperature Restoration
# Purpose: Save thermostat setpoints before window-triggered shutoff
#          (TRVZB firmware drops setpoint to frost protection when turned off)
# =============================================================================
input_number:
  # NOTE: No 'initial:' - state preserved across HA restarts
  # Values persist so setpoints survive HA restart during window shutoff
  study_heater_saved_temp:
    name: Study Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  living_inner_heater_saved_temp:
    name: Living Inner Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  living_outer_heater_saved_temp:
    name: Living Outer Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  bedroom_heater_saved_temp:
    name: Bedroom Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  # Bedroom Night Mode - Save setpoint before 23:00 cap
  bedroom_pre_night_setpoint:
    name: Bedroom Pre-Night Setpoint
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:bed-clock

# =============================================================================
# HOT WATER USAGE TRACKING
# Purpose: Track hot water usage via vibration sensor on hot water pipe
# Sensor: HOBEIAN ZG-102ZM (address: 0xa4c13863257ea097)
# Behavior: Maintains vibration:true/false state (tested live 2024-12-29)
# =============================================================================

# MQTT binary sensor to expose vibration as hot water running state
mqtt:
  binary_sensor:
    - name: "Hot Water Running"
      unique_id: hot_water_running
      state_topic: "zigbee2mqtt/Vibration Sensor"
      value_template: "{{ 'ON' if value_json.vibration == true else 'OFF' }}"
      device_class: running
      icon: mdi:water-boiler

# History tracking sensors (history_stats)
sensor:
  - platform: history_stats
    name: Hot Water Today
    entity_id: binary_sensor.hot_water_running
    state: "on"
    type: time
    start: "{{ today_at('00:00') }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: Hot Water Yesterday
    entity_id: binary_sensor.hot_water_running
    state: "on"
    type: time
    start: "{{ today_at('00:00') - timedelta(days=1) }}"
    end: "{{ today_at('00:00') }}"

  - platform: history_stats
    name: Hot Water 7 Days
    entity_id: binary_sensor.hot_water_running
    state: "on"
    type: time
    start: "{{ today_at('00:00') - timedelta(days=7) }}"
    end: "{{ now() }}"

# Template sensors for user-friendly units (seconds/minutes)
template:
  - sensor:
      - name: "Hot Water Today Seconds"
        unique_id: hot_water_today_seconds
        unit_of_measurement: "s"
        state_class: measurement
        icon: mdi:water-boiler
        state: "{{ (states('sensor.hot_water_today') | float(0) * 3600) | round(0) }}"

      - name: "Hot Water Today Minutes"
        unique_id: hot_water_today_minutes
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:clock-outline
        state: "{{ (states('sensor.hot_water_today') | float(0) * 60) | round(1) }}"

      - name: "Hot Water Yesterday Seconds"
        unique_id: hot_water_yesterday_seconds
        unit_of_measurement: "s"
        state_class: measurement
        icon: mdi:water-boiler
        state: "{{ (states('sensor.hot_water_yesterday') | float(0) * 3600) | round(0) }}"

      - name: "Hot Water 7 Days Minutes"
        unique_id: hot_water_7_days_minutes
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:chart-bar
        state: "{{ (states('sensor.hot_water_7_days') | float(0) * 60) | round(1) }}"

# =============================================================================
# AUTOMATIONS
# Purpose: Event-driven actions for smart home
# =============================================================================
automation: !include automations.yaml

# =============================================================================
# SCRIPTS
# Purpose: Reusable automation actions (smart TTS with retry, etc.)
# =============================================================================
script: !include scripts.yaml
