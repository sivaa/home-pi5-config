homeassistant:
  name: Home
  unit_system: metric
  time_zone: Europe/Berlin
  internal_url: "http://pi:8123"
  external_url: "https://ha.sivaa.in"
  customize:
    media_player.broken_display:
      friendly_name: "Broken Display"

frontend:
config:
mobile_app:
sun:  # Required for sun.sun entity (sunrise/sunset tracking)

# =============================================================================
# NOTIFICATION GROUPS
# Purpose: Send mobile push notifications
# Phones:
#   - mobile_app_nithya_mobile (Nithya)
#   Siva removed Feb 2026 — prefers email-only (siva@sivaa.net)
# =============================================================================
notify:
  - platform: group
    name: all_phones
    services:
      - action: mobile_app_nithya_mobile

  # =========================================================================
  # EMAIL NOTIFICATIONS (Gmail SMTP)
  # ┌─────────────────────────────────────────────────────────────────────┐
  # │  PURPOSE: Send email alerts for critical events                     │
  # │                                                                     │
  # │  Automation ──► notify.all_phones  (Nithya mobile push)            │
  # │              └► notify.email       (Siva email paper trail)        │
  # │                                                                     │
  # │  WHY EMAIL + PHONE?                                                │
  # │  Phone notifications vanish when dismissed. Emails persist.         │
  # │  If your phone dies at 3 AM and CO2 hits critical,                 │
  # │  the email is waiting when you wake up.                            │
  # │                                                                     │
  # │  SETUP: zoobave@gmail.com needs an App Password                    │
  # │         (Google Account → Security → App Passwords)                │
  # │  CREDS: !secret gmail_app_password in secrets.yaml                 │
  # └─────────────────────────────────────────────────────────────────────┘
  # =========================================================================
  - platform: smtp
    name: email
    server: smtp.gmail.com
    port: 587
    encryption: starttls
    sender: zoobave@gmail.com
    username: zoobave@gmail.com
    password: !secret gmail_app_password
    recipient:
      - siva@sivaa.net
    sender_name: "Pi Home Assistant"

http:
  server_port: 8123
  use_x_forwarded_for: true
  cors_allowed_origins:
    - http://localhost:8888
    - http://127.0.0.1:8888
    - http://pi:8888
  trusted_proxies:
    # Local/Docker
    - 127.0.0.1
    - ::1
    - 172.16.0.0/12
    # Cloudflare IPv4 ranges
    - 173.245.48.0/20
    - 103.21.244.0/22
    - 103.22.200.0/22
    - 103.31.4.0/22
    - 141.101.64.0/18
    - 108.162.192.0/18
    - 190.93.240.0/20
    - 188.114.96.0/20
    - 197.234.240.0/22
    - 198.41.128.0/17
    - 162.158.0.0/15
    - 104.16.0.0/13
    - 104.24.0.0/14
    - 172.64.0.0/13
    - 131.0.72.0/22
    # Cloudflare IPv6 ranges
    - 2400:cb00::/32
    - 2606:4700::/32
    - 2803:f800::/32
    - 2405:b500::/32
    - 2405:8100::/32
    - 2a06:98c0::/29
    - 2c0f:f248::/32

# MQTT - Configured via UI integration (Settings > Devices & Services > MQTT)
# VPN provides network security - no MQTT authentication needed
# broker: localhost, port: 1883 (must use localhost, not Docker hostname, with --network host)

# InfluxDB integration - writes sensor data directly
# NOTE: Must use localhost, not "influxdb" Docker hostname, when HA uses --network host
influxdb:
  host: localhost
  port: 8086
  database: homeassistant
  default_measurement: state
  include:
    entity_globs:
      - sensor.*temperature*
      - sensor.*humidity*
      - sensor.*battery*
      - sensor.*co2*
      - sensor.*air_quality*
      - binary_sensor.hot_water_running
      - sensor.hot_water_*

# Recorder for local history
recorder:
  purge_keep_days: 7
  commit_interval: 60
  include:
    entity_globs:
      - sensor.*temperature*
      - sensor.*humidity*
      - sensor.*co2*
      - sensor.*air_quality*
      - media_player.*  # Track Cast device availability for TTS debugging
      - binary_sensor.hot_water_running
      - sensor.hot_water_*

logger:
  default: warning
  logs:
    homeassistant.components.influxdb: info
    homeassistant.components.google_assistant: info
    homeassistant.components.automation: info
    homeassistant.components.tts: info

# =============================================================================
# MEDIA SOURCE (Required for TTS)
# =============================================================================
media_source:

# =============================================================================
# LG WEBOS TV
# ┌─────────────────────────────────────────────────────────────────┐
# │  Model: LG 65SM8500PLA (webOS 4.5)                             │
# │  IP: 192.168.0.168 │ MAC: f0:86:20:a6:12:f0                    │
# │                                                                 │
# │  How it works:                                                  │
# │    ┌──────────┐  webOS API   ┌──────┐  WoL magic pkt  ┌──────┐ │
# │    │   HA     │────────────→ │  TV  │ ←──────────────  │  HA  │ │
# │    │ (control)│  (off/vol/…) │      │   (wake from     │(turn │ │
# │    └──────────┘              └──────┘    standby)       │ on)  │ │
# │                                                        └──────┘ │
# │  Setup: UI only (Settings → Devices → Add → LG webOS)          │
# │  First run: Accept pairing prompt on TV screen (one-time)       │
# │  Voice: "Hey Google, turn on/off the TV"                        │
# │                                                                 │
# │  NOTE: webostv integration does NOT support YAML config.        │
# │  Configure via: Settings → Devices & Services → Add → LG webOS │
# │  Turn-on via WoL: configure in integration options after adding │
# └─────────────────────────────────────────────────────────────────┘
# =============================================================================

# Wake-on-LAN: Required for turning on the TV from standby
# The webOS integration (added via UI) uses this to send magic packets
wake_on_lan:

# =============================================================================
# TEXT-TO-SPEECH (TTS)
# Purpose: Voice announcements via Google Home speakers
# Docs: https://www.home-assistant.io/integrations/google_translate/
# =============================================================================
tts:
  - platform: google_translate
    language: 'en'

# =============================================================================
# GOOGLE ASSISTANT INTEGRATION
# Purpose: Voice control via Google Home devices
# Docs: https://www.home-assistant.io/integrations/google_assistant/
# =============================================================================
google_assistant:
  project_id: siva-home-assistant-1
  service_account: !include SERVICE_ACCOUNT.json
  report_state: true
  expose_by_default: false
  exposed_domains:
    - light
    - switch
    - sensor
    - climate
    - binary_sensor
    - media_player
  entity_config:
    # === LIGHTS (Voice controllable) ===
    light.study_ikea_light:
      name: "Study Light"
      expose: true
      room: "Study"
      aliases:
        - "Office Light"
        - "Study Room Light"

    light.living_ikea_light:
      name: "Living Room Light"
      expose: true
      room: "Living Room"
      aliases:
        - "Lounge Light"
        - "Main Light"

    light.bath_light:
      name: "Bath Light"
      expose: true
      room: "Bathroom"
      aliases:
        - "Bathroom Light"

    # === SMART PLUG (Voice controllable) ===
    switch.smart_plug_1:
      name: "Smart Plug"
      expose: true
      room: "Living Room"
      aliases:
        - "Plug"
        - "Power Plug"

    # === LIGHT SWITCHES (Voice controllable) ===
    switch.study_light_switch:
      name: "Study Switch"
      expose: true
      room: "Study"
      aliases:
        - "Study Light Switch"
        - "Office Switch"

    switch.bed_light_switch:
      name: "Bedroom Switch"
      expose: true
      room: "Bedroom"
      aliases:
        - "Bedroom Light Switch"
        - "Bed Switch"

    switch.living_light_switch:
      name: "Living Room Switch"
      expose: true
      room: "Living Room"
      aliases:
        - "Living Light Switch"
        - "Lounge Switch"

    # === FINGERBOT (Voice controllable) ===
    switch.fingerbot:
      name: "Fingerbot"
      expose: true
      room: "Hallway"
      aliases:
        - "Button Pusher"
        - "Robot Button"

    # === LG TV (Voice controllable) ===
    # Expose the template switch, NOT the raw media_player
    # media_player goes "unavailable" when TV is off → Google blocks commands
    # The switch always reports on/off → Google always forwards commands
    switch.living_room_tv_power:
      name: "Living Room TV"
      expose: true
      room: "Living Room"
      aliases:
        - "TV"
        - "Television"
    media_player.living_room_tv:
      expose: false

    # === TEMPERATURE SENSORS (Read-only, queryable) ===
    sensor.study_temperature_humidity_temperature:
      name: "Study Temperature"
      expose: true
      room: "Study"

    sensor.living_temperature_humidity_temperature:
      name: "Living Room Temperature"
      expose: true
      room: "Living Room"

    sensor.bed_temperature_humidity_sensor_temperature:
      name: "Bedroom Temperature"
      expose: true
      room: "Bedroom"

    sensor.kitchen_temperature_humidity_temperature:
      name: "Kitchen Temperature"
      expose: true
      room: "Kitchen"

    sensor.bath_temperature_humidity_temperature:
      name: "Bathroom Temperature"
      expose: true
      room: "Bathroom"

    sensor.balcony_temperature_humidity_temperature:
      name: "Balcony Temperature"
      expose: true
      room: "Balcony"

    # === HUMIDITY SENSORS ===
    sensor.study_temperature_humidity_humidity:
      name: "Study Humidity"
      expose: true
      room: "Study"

    sensor.living_temperature_humidity_humidity:
      name: "Living Room Humidity"
      expose: true
      room: "Living Room"

    sensor.bed_temperature_humidity_sensor_humidity:
      name: "Bedroom Humidity"
      expose: true
      room: "Bedroom"

    # === CO2 SENSOR ===
    sensor.hallway_co2_co2:
      name: "Air Quality"
      expose: true
      room: "Hallway"
      aliases:
        - "CO2 Sensor"
        - "Air Quality Sensor"

    # === MOTION SENSOR (Mailbox) ===
    binary_sensor.mailbox_motion_sensor_occupancy:
      name: "Mailbox Sensor"
      expose: true
      room: "Entry"
      aliases:
        - "Mail Sensor"

    # === THERMOSTATS (Climate control) ===
    climate.study_thermostat:
      name: "Study Thermostat"
      expose: true
      room: "Study"
      aliases:
        - "Study Heater"
        - "Office Thermostat"

    climate.living_thermostat_inner:
      name: "Living Inner"
      expose: true
      room: "Living Room"
      aliases:
        - "Living Inner Thermostat"
        - "Living Inner Heater"

    climate.living_thermostat_outer:
      name: "Living Outer"
      expose: true
      room: "Living Room"
      aliases:
        - "Living Outer Thermostat"
        - "Living Outer Heater"

    climate.bed_thermostat:
      name: "Bedroom Thermostat"
      expose: true
      room: "Bedroom"
      aliases:
        - "Bedroom Heater"
        - "Bed Heater"

    # === ADDITIONAL SMART PLUGS (Voice controllable) ===
    switch.smart_plug_2:
      name: "Smart Plug 2"
      expose: true
      room: "Kitchen"
      aliases:
        - "Kitchen Plug"
        - "Plug Two"

    switch.smart_plug_3:
      name: "Smart Plug 3"
      expose: true
      room: "Bedroom"
      aliases:
        - "Bedroom Plug"
        - "Plug Three"

    # === PRESENCE SENSOR (Queryable) ===
    binary_sensor.human_presence_occupancy:
      name: "Human Presence"
      expose: true
      room: "Hallway"
      aliases:
        - "Presence Sensor"
        - "Motion Detector"

    # === VIBRATION SENSOR - Hot Water (Queryable) ===
    binary_sensor.vibration_sensor_vibration:
      name: "Hot Water Sensor"
      expose: true
      room: "Bathroom"
      aliases:
        - "Vibration Sensor"
        - "Water Running"

    # === ADDITIONAL HUMIDITY SENSORS ===
    sensor.kitchen_temperature_humidity_humidity:
      name: "Kitchen Humidity"
      expose: true
      room: "Kitchen"

    sensor.bath_temperature_humidity_humidity:
      name: "Bathroom Humidity"
      expose: true
      room: "Bathroom"

    sensor.balcony_temperature_humidity_humidity:
      name: "Balcony Humidity"
      expose: true
      room: "Balcony"

    # === WINDOW/DOOR CONTACT SENSORS (Queryable) ===
    binary_sensor.study_window_contact_sensor_large_contact:
      name: "Study Large Window"
      expose: true
      room: "Study"
      aliases:
        - "Study Big Window"
        - "Office Window"

    binary_sensor.study_window_contact_sensor_small_contact:
      name: "Study Small Window"
      expose: true
      room: "Study"
      aliases:
        - "Study Little Window"

    binary_sensor.living_window_contact_sensor_window_contact:
      name: "Living Room Window"
      expose: true
      room: "Living Room"
      aliases:
        - "Lounge Window"

    binary_sensor.living_window_contact_sensor_balcony_door_contact:
      name: "Balcony Door"
      expose: true
      room: "Living Room"
      aliases:
        - "Living Balcony Door"

    binary_sensor.bed_window_contact_sensor_contact:
      name: "Bedroom Window"
      expose: true
      room: "Bedroom"
      aliases:
        - "Bed Window"

    binary_sensor.kitchen_window_contact_sensor_contact:
      name: "Kitchen Window"
      expose: true
      room: "Kitchen"

    binary_sensor.bath_window_contact_sensor_contact:
      name: "Bathroom Window"
      expose: true
      room: "Bathroom"
      aliases:
        - "Bath Window"

    binary_sensor.hallway_window_contact_sensor_main_door_contact:
      name: "Front Door"
      expose: true
      room: "Entry"
      aliases:
        - "Main Door"
        - "Entry Door"

# =============================================================================
# WEATHER INTEGRATION
# Purpose: Official weather forecast for Zehlendorf, Berlin (used in dashboard header)
# Docs: https://www.home-assistant.io/integrations/met/
# =============================================================================
weather:
  - platform: met
    name: Zehlendorf Weather
    latitude: 52.4319
    longitude: 13.2599

# =============================================================================
# LIGHT GROUPS
# Purpose: Group lights for easier control and scalability
# =============================================================================
light:
  - platform: group
    name: "IKEA Lights"
    unique_id: ikea_lights_group
    entities:
      - light.study_ikea_light
      - light.living_ikea_light

# =============================================================================
# INPUT BOOLEANS - State Memory for Automations
# Purpose: Remember heater states before window-triggered shutoff
# =============================================================================
input_boolean:
  # NOTE: No 'initial:' - state preserved across HA restarts
  study_heater_was_on:
    name: Study Heater Was On
  living_inner_heater_was_on:
    name: Living Inner Heater Was On
  living_outer_heater_was_on:
    name: Living Outer Heater Was On
  bedroom_heater_was_on:
    name: Bedroom Heater Was On
  # Guard flag to prevent state overwrite when multiple windows open
  heaters_off_due_to_window:
    name: Heaters Off Due To Window
    icon: mdi:window-open-variant
  # Guard flag for CO2-triggered heater shutoff
  heaters_off_due_to_co2:
    name: Heaters Off Due To CO2
    icon: mdi:molecule-co2
  # CO2 override flag (allows heaters when CO2 is high for 6 hours)
  co2_override_active:
    name: CO2 Override Active
    icon: mdi:shield-off-outline
  # Bedroom night mode flag (23:00-06:00 temperature limit)
  bedroom_night_mode_active:
    name: Bedroom Night Mode Active
    icon: mdi:weather-night
  # =========================================================================
  # CIRCADIAN LIGHTING FLAGS
  # Purpose: Track circadian state and manual overrides for IKEA lights
  # =========================================================================
  circadian_enabled:
    name: Circadian Lighting Enabled
    icon: mdi:brightness-auto
  # Debounce flag - set when automation is actively changing lights
  # Used to distinguish automation changes from manual remote presses
  circadian_automation_active:
    name: Circadian Automation Active
    icon: mdi:sync
  # Per-light override flags
  circadian_study_override:
    name: Study Light Override
    icon: mdi:hand-back-right
  circadian_living_override:
    name: Living Light Override
    icon: mdi:hand-back-right
  circadian_bath_override:
    name: Bath Light Override
    icon: mdi:hand-back-right

# =============================================================================
# INPUT DATETIMES - Override Expiration Timestamps
# Purpose: Track when manual overrides should expire (30 min from trigger)
# =============================================================================
input_datetime:
  circadian_study_override_expires:
    name: Study Override Expires
    has_date: true
    has_time: true
    icon: mdi:timer-sand
  circadian_living_override_expires:
    name: Living Override Expires
    has_date: true
    has_time: true
    icon: mdi:timer-sand
  circadian_bath_override_expires:
    name: Bath Override Expires
    has_date: true
    has_time: true
    icon: mdi:timer-sand
  # Bedroom night mode override expiry (for dashboard 90-min override)
  bedroom_night_override_end:
    name: Bedroom Night Override Expires
    has_date: true
    has_time: true
    icon: mdi:timer-sand
  # Thermostat boost expiry times (dashboard 60-min boost feature)
  study_boost_end:
    name: Study Boost Expires
    has_date: true
    has_time: true
    icon: mdi:fire
  living_inner_boost_end:
    name: Living Inner Boost Expires
    has_date: true
    has_time: true
    icon: mdi:fire
  living_outer_boost_end:
    name: Living Outer Boost Expires
    has_date: true
    has_time: true
    icon: mdi:fire
  bedroom_boost_end:
    name: Bedroom Boost Expires
    has_date: true
    has_time: true
    icon: mdi:fire
  # Global boost mode expiry (enables 25°C limit for 60 min)
  global_boost_end:
    name: Global Boost Mode Expires
    has_date: true
    has_time: true
    icon: mdi:fire-alert
  # CO2 override expiry (allows heaters despite high CO2 for 6 hours)
  co2_override_end:
    name: CO2 Override Expires
    has_date: true
    has_time: true
    icon: mdi:shield-off-outline

  # CO2 Episode Tracking - for accurate ventilation time announcements
  # Sentinel value "1970-01-01 00:00:00" means "not tracking"
  co2_high_started:
    name: "CO2 Episode Started"
    has_date: true
    has_time: true
    icon: mdi:molecule-co2
  co2_window_opened:
    name: "CO2 Window Opened"
    has_date: true
    has_time: true
    icon: mdi:window-open

  # =========================================================================
  # STUCK-IDLE RECOVERY — Rate Limiting Windows
  # Purpose: Track when the sliding 1-hour recovery window started per TRV
  # Used by: thermostat_stuck_idle_recovery automation
  # Sentinel "1970-01-01 00:00:00" = no active window (same pattern as CO2)
  # =========================================================================
  study_idle_recovery_window_start:
    name: "Study Idle Recovery Window Start"
    has_date: true
    has_time: true
    icon: mdi:timer-sand
  living_inner_idle_recovery_window_start:
    name: "Living Inner Idle Recovery Window Start"
    has_date: true
    has_time: true
    icon: mdi:timer-sand
  living_outer_idle_recovery_window_start:
    name: "Living Outer Idle Recovery Window Start"
    has_date: true
    has_time: true
    icon: mdi:timer-sand
  bedroom_idle_recovery_window_start:
    name: "Bedroom Idle Recovery Window Start"
    has_date: true
    has_time: true
    icon: mdi:timer-sand

# =============================================================================
# INPUT NUMBERS - Saved Setpoints for Temperature Restoration
# Purpose: Save thermostat setpoints before window-triggered shutoff
#          (TRVZB firmware drops setpoint to frost protection when turned off)
# =============================================================================
input_number:
  # NOTE: No 'initial:' - state preserved across HA restarts
  # Values persist so setpoints survive HA restart during window shutoff
  study_heater_saved_temp:
    name: Study Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  living_inner_heater_saved_temp:
    name: Living Inner Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  living_outer_heater_saved_temp:
    name: Living Outer Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  bedroom_heater_saved_temp:
    name: Bedroom Heater Saved Temp
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  # Bedroom Night Mode - Save setpoint before 23:00 cap
  bedroom_pre_night_setpoint:
    name: Bedroom Pre-Night Setpoint
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:bed-clock
  # Thermostat boost - Save setpoints before 22°C boost (dashboard feature)
  study_pre_boost_setpoint:
    name: Study Pre-Boost Setpoint
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:fire
  living_inner_pre_boost_setpoint:
    name: Living Inner Pre-Boost Setpoint
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:fire
  living_outer_pre_boost_setpoint:
    name: Living Outer Pre-Boost Setpoint
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:fire
  bedroom_pre_boost_setpoint:
    name: Bedroom Pre-Boost Setpoint
    min: 5
    max: 22
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:fire
  # Global boost mode - Save temps before enabling 25°C limit (for restoration)
  global_boost_saved_study:
    name: Global Boost Saved - Study
    min: 5
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:fire-alert
  global_boost_saved_living_inner:
    name: Global Boost Saved - Living Inner
    min: 5
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:fire-alert
  global_boost_saved_living_outer:
    name: Global Boost Saved - Living Outer
    min: 5
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:fire-alert
  global_boost_saved_bedroom:
    name: Global Boost Saved - Bedroom
    min: 5
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:fire-alert
  # =========================================================================
  # STUCK-IDLE RECOVERY — Attempt Counters
  # Purpose: Count recovery attempts per TRV in sliding 1-hour window
  # Used by: thermostat_stuck_idle_recovery + thermostat_stuck_idle_max_attempts
  # Reset to 0 when window expires (>1 hour since window_start)
  # =========================================================================
  study_idle_recovery_count:
    name: Study Idle Recovery Count
    min: 0
    max: 10
    step: 1
    icon: mdi:counter
  living_inner_idle_recovery_count:
    name: Living Inner Idle Recovery Count
    min: 0
    max: 10
    step: 1
    icon: mdi:counter
  living_outer_idle_recovery_count:
    name: Living Outer Idle Recovery Count
    min: 0
    max: 10
    step: 1
    icon: mdi:counter
  bedroom_idle_recovery_count:
    name: Bedroom Idle Recovery Count
    min: 0
    max: 10
    step: 1
    icon: mdi:counter

# =============================================================================
# HOT WATER USAGE TRACKING
# Purpose: Track hot water usage via vibration sensor on hot water pipe
# Sensor: HOBEIAN ZG-102ZM (address: 0xa4c13863257ea097)
# Behavior: Maintains vibration:true/false state (tested live 2024-12-29)
# =============================================================================

# MQTT binary sensor to expose vibration as hot water running state
mqtt:
  binary_sensor:
    - name: "Hot Water Running"
      unique_id: hot_water_running
      state_topic: "zigbee2mqtt/Vibration Sensor"
      value_template: "{{ 'ON' if value_json.vibration == true else 'OFF' }}"
      device_class: running
      icon: mdi:water-boiler

# =============================================================================
# MQTT STATESTREAM - Publish entity states to MQTT for dashboard
# Purpose: Exposes circadian lighting state to the web dashboard via MQTT
# Topics published: homeassistant/sensor/circadian_*/state, etc.
# =============================================================================
mqtt_statestream:
  base_topic: homeassistant
  publish_attributes: true
  include:
    entities:
      # Circadian sensors
      - sensor.circadian_phase
      - sensor.circadian_brightness
      - sensor.circadian_color_temp
      # Circadian control flags
      - input_boolean.circadian_enabled
      - input_boolean.circadian_study_override
      - input_boolean.circadian_living_override
      - input_boolean.circadian_bath_override
      # Override expiration timestamps
      - input_datetime.circadian_study_override_expires
      - input_datetime.circadian_living_override_expires
      - input_datetime.circadian_bath_override_expires

# History tracking sensors (history_stats)
sensor:
  - platform: history_stats
    name: Hot Water Today
    entity_id: binary_sensor.hot_water_running
    state: "on"
    type: time
    start: "{{ today_at('00:00') }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: Hot Water Yesterday
    entity_id: binary_sensor.hot_water_running
    state: "on"
    type: time
    start: "{{ today_at('00:00') - timedelta(days=1) }}"
    end: "{{ today_at('00:00') }}"

  - platform: history_stats
    name: Hot Water 7 Days
    entity_id: binary_sensor.hot_water_running
    state: "on"
    type: time
    start: "{{ today_at('00:00') - timedelta(days=7) }}"
    end: "{{ now() }}"

# Template sensors for user-friendly units (seconds/minutes)
template:
  - sensor:
      - name: "Hot Water Today Seconds"
        unique_id: hot_water_today_seconds
        unit_of_measurement: "s"
        state_class: measurement
        icon: mdi:water-boiler
        state: "{{ (states('sensor.hot_water_today') | float(0) * 3600) | round(0) }}"

      - name: "Hot Water Today Minutes"
        unique_id: hot_water_today_minutes
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:clock-outline
        state: "{{ (states('sensor.hot_water_today') | float(0) * 60) | round(1) }}"

      - name: "Hot Water Yesterday Seconds"
        unique_id: hot_water_yesterday_seconds
        unit_of_measurement: "s"
        state_class: measurement
        icon: mdi:water-boiler
        state: "{{ (states('sensor.hot_water_yesterday') | float(0) * 3600) | round(0) }}"

      - name: "Hot Water 7 Days Minutes"
        unique_id: hot_water_7_days_minutes
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:chart-bar
        state: "{{ (states('sensor.hot_water_7_days') | float(0) * 60) | round(1) }}"

      # =========================================================================
      # CIRCADIAN LIGHTING SENSORS
      # Purpose: Calculate scheduled brightness and color temp based on time
      # Schedule:
      #   Night (22:00-06:00): 1% brightness, 454 mired (warmest)
      #   Sunrise (06:00-07:30): Gradual 1%→100%, 454→320 mired
      #   Day (07:30-18:00): 100% brightness, 320 mired (neutral)
      #   Sunset (18:00-22:00): Gradual 100%→1%, 320→454 mired
      # Update frequency: Every 1 minute for ~0.4% steps during transitions
      # =========================================================================
      - name: "Circadian Brightness"
        unique_id: circadian_brightness
        unit_of_measurement: "%"
        icon: mdi:brightness-6
        state: >
          {% set hour = now().hour %}
          {% set minute = now().minute %}
          {% set t = hour + minute / 60 %}
          {% if t < 6 %}
            1
          {% elif t < 7.5 %}
            {{ (1 + (t - 6) / 1.5 * 99) | round(0) }}
          {% elif t < 18 %}
            100
          {% elif t < 22 %}
            {{ (100 - (t - 18) / 4 * 99) | round(0) }}
          {% else %}
            1
          {% endif %}

      - name: "Circadian Color Temp"
        unique_id: circadian_color_temp
        unit_of_measurement: "K"
        icon: mdi:thermometer-lines
        state: >
          {% set hour = now().hour %}
          {% set minute = now().minute %}
          {% set t = hour + minute / 60 %}
          {% if t < 6 %}
            2200
          {% elif t < 7.5 %}
            {{ (2200 + (t - 6) / 1.5 * 925) | round(0) }}
          {% elif t < 18 %}
            3125
          {% elif t < 22 %}
            {{ (3125 - (t - 18) / 4 * 925) | round(0) }}
          {% else %}
            2200
          {% endif %}

  # =========================================================================
  # TV POWER SWITCH (Google Assistant Workaround)
  # ┌─────────────────────────────────────────────────────────────────┐
  # │  PROBLEM: When TV is off, webOS reports "unavailable"          │
  # │  Google sees "unavailable" → thinks device is offline          │
  # │  → refuses to forward "turn on" command → deadlock!            │
  # │                                                                 │
  # │  media_player.living_room_tv                                   │
  # │    TV on  → state: "on"          → Google: online  ✓           │
  # │    TV off → state: "unavailable" → Google: OFFLINE ✗           │
  # │                                                                 │
  # │  switch.living_room_tv_power (this template)                   │
  # │    TV on  → state: "on"  → Google: online ✓ → can turn off    │
  # │    TV off → state: "off" → Google: online ✓ → can turn on!    │
  # └─────────────────────────────────────────────────────────────────┘
  # =========================================================================
  - switch:
      - name: "Living Room TV Power"
        unique_id: living_room_tv_power
        icon: mdi:television
        state: >
          {{ states('media_player.living_room_tv') not in
             ['unavailable', 'unknown', 'off'] }}
        turn_on:
          action: media_player.turn_on
          target:
            entity_id: media_player.living_room_tv
        turn_off:
          action: media_player.turn_off
          target:
            entity_id: media_player.living_room_tv

  - sensor:
      - name: "Circadian Phase"
        unique_id: circadian_phase
        icon: mdi:theme-light-dark
        state: >
          {% set hour = now().hour %}
          {% set minute = now().minute %}
          {% set t = hour + minute / 60 %}
          {% if t < 6 %}
            Night
          {% elif t < 7.5 %}
            Sunrise
          {% elif t < 18 %}
            Day
          {% elif t < 22 %}
            Sunset
          {% else %}
            Night
          {% endif %}

# =============================================================================
# SHELL COMMANDS
# Purpose: Allow dashboard to trigger container operations via API
# Usage: POST /api/services/shell_command/start_data_scraper
# =============================================================================
shell_command:
  # Uses Docker socket (mounted in HA container) to start scraper via API
  # curl talks to Docker API directly since docker CLI isn't in HA image
  start_data_scraper: "curl -s --unix-socket /var/run/docker.sock -X POST http://localhost/v1.44/containers/data-scraper/start"

# =============================================================================
# AUTOMATIONS
# Purpose: Event-driven actions for smart home
# =============================================================================
automation: !include automations.yaml

# =============================================================================
# SCRIPTS
# Purpose: Reusable automation actions (smart TTS with retry, etc.)
# =============================================================================
script: !include scripts.yaml
