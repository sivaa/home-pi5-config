# =============================================================================
# HOME ASSISTANT AUTOMATIONS
# Purpose: Event-driven actions for smart home
# =============================================================================

# -----------------------------------------------------------------------------
# MAILBOX MOTION ALERT
# Trigger: Motion detected at mailbox (PIR sensor)
# Action: TTS announcement on ALL Google Home devices
# Quiet Hours: 23:00 - 06:00 (no announcements)
# Cooldown: 30 seconds (prevents spam from continuous motion)
# -----------------------------------------------------------------------------
- id: mailbox_motion_alert
  alias: "Mailbox Motion Alert"
  description: "Announces when motion is detected at the mailbox"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.motion_detector_occupancy
      to: "on"

  condition:
    # Quiet hours: no announcements between 23:00 and 06:00
    - condition: time
      after: "06:00:00"
      before: "23:00:00"
    # 30-second cooldown to prevent spam
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.mailbox_motion_alert', 'last_triggered')).total_seconds() > 30
           if state_attr('automation.mailbox_motion_alert', 'last_triggered') is not none
           else true }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: "Mailbox opened"
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "üì¨ Mailbox"
        message: "Motion detected at mailbox"
        data:
          channel: "Alerts"
          importance: high

# -----------------------------------------------------------------------------
# CO2 LEVEL ALERT
# Trigger: CO2 level rises above 1200 ppm
# Action: TTS announcement to ventilate
# Cooldown: 10 minutes (prevents repeated announcements)
# -----------------------------------------------------------------------------
- id: co2_high_alert
  alias: "CO2 High Level Alert"
  description: "Announces when CO2 levels are too high and ventilation is needed"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.co2_co2
      above: 1200

  condition:
    # Only announce during waking hours (7 AM to 11 PM)
    - condition: time
      after: "07:00:00"
      before: "23:00:00"
    # 10-minute cooldown to prevent spam
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_high_level_alert', 'last_triggered')).total_seconds() > 600
           if state_attr('automation.co2_high_level_alert', 'last_triggered') is not none
           else true }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id: media_player.kitchen_display
        message: >
          Nithya, the Criuse Owner, please ventilate. The current CO2 level is above {{ (states('sensor.co2_co2') | int // 100) * 100 }}.
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "‚ö†Ô∏è CO2 High"
        message: "CO2 above {{ states('sensor.co2_co2') }} ppm - please ventilate"
        data:
          channel: "Alerts"
          importance: high

# -----------------------------------------------------------------------------
# CO2 CRITICAL ALERT
# Trigger: CO2 level rises above 1600 ppm (very high)
# Action: Urgent TTS announcement + mobile notification
# Cooldown: 5 minutes (shorter due to urgency)
# NOTE: NO quiet hours - safety critical, runs 24/7
# -----------------------------------------------------------------------------
- id: co2_critical_alert
  alias: "CO2 Critical Level Alert"
  description: "Urgent announcement when CO2 levels are dangerously high"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.co2_co2
      above: 1600

  condition:
    # 5-minute cooldown (shorter due to urgency)
    # NOTE: No quiet hours - this is safety critical and runs 24/7
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_critical_level_alert', 'last_triggered')).total_seconds() > 300
           if state_attr('automation.co2_critical_level_alert', 'last_triggered') is not none
           else true }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id: media_player.kitchen_display
        message: >
          Warning! CO2 level is very high at {{ (states('sensor.co2_co2') | int // 100) * 100 }}. Please open windows immediately!
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "üö® CO2 CRITICAL"
        message: "CO2 at {{ states('sensor.co2_co2') }} ppm - OPEN WINDOWS NOW!"
        data:
          channel: "Critical"
          importance: max
          vibrationPattern: "100, 1000, 100, 1000, 100"

# -----------------------------------------------------------------------------
# CO2 GOOD LEVEL NOTIFICATION
# Trigger: CO2 level drops below 500 ppm (good air quality)
# Action: Thank Nithya and announce ventilation complete
# Cooldown: 30 minutes (stable good level)
# -----------------------------------------------------------------------------
- id: co2_good_level
  alias: "CO2 Good Level Notification"
  description: "Announces when air quality is good after ventilation"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.co2_co2
      below: 500

  condition:
    # Only announce during waking hours (7 AM to 11 PM)
    - condition: time
      after: "07:00:00"
      before: "23:00:00"
    # 30-minute cooldown
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_good_level_notification', 'last_triggered')).total_seconds() > 1800
           if state_attr('automation.co2_good_level_notification', 'last_triggered') is not none
           else true }}
    # Only announce if there was a recent high alert (within last 2 hours)
    - condition: template
      value_template: >
        {% set high_alert = state_attr('automation.co2_high_level_alert', 'last_triggered') %}
        {% set critical_alert = state_attr('automation.co2_critical_level_alert', 'last_triggered') %}
        {% set alerts = [high_alert, critical_alert] | select('ne', none) | list %}
        {{ alerts | length > 0 and (now() - alerts | max).total_seconds() < 7200 }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id: media_player.kitchen_display
        message: >
          {% set high_alert = state_attr('automation.co2_high_level_alert', 'last_triggered') %}
          {% set critical_alert = state_attr('automation.co2_critical_level_alert', 'last_triggered') %}
          {% set alerts = [high_alert, critical_alert] | select('ne', none) | list %}
          {% set minutes = ((now() - alerts | max).total_seconds() / 60) | round(0) | int %}
          Thanks Nithya! Air quality is good now. Ventilated in {{ minutes }} minutes. You can close the windows.
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "‚úÖ Air Quality Good"
        message: "CO2 now {{ states('sensor.co2_co2') }} ppm - windows can be closed"
        data:
          channel: "Info"
          importance: default

# -----------------------------------------------------------------------------
# BATHROOM WINDOW OPEN TOO LONG
# Trigger: Window open for more than 10 minutes
# Action: TTS announcement every minute until closed
# -----------------------------------------------------------------------------
- id: bath_window_open_too_long
  alias: "Bathroom Window Open Too Long"
  description: "Alerts when bathroom window is open for more than 10 minutes"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.bath_window_contact_sensor_contact
      to: "on"
      for:
        minutes: 10

  action:
    - repeat:
        while:
          - condition: state
            entity_id: binary_sensor.bath_window_contact_sensor_contact
            state: "on"
        sequence:
          - service: tts.google_translate_say
            data:
              entity_id: media_player.kitchen_display
              message: >
                {% set minutes = ((now() - states.binary_sensor.bath_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Bathroom window has been open for {{ minutes }} minutes.
              language: "en"
          - service: notify.mobile_app_22111317pg
            data:
              title: "ü™ü Bathroom Window"
              message: >
                {% set minutes = ((now() - states.binary_sensor.bath_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Open for {{ minutes }} minutes
              data:
                channel: "Alerts"
                importance: high
                tag: "bath_window"
          - delay:
              minutes: 1

# -----------------------------------------------------------------------------
# BEDROOM WINDOW OPEN TOO LONG
# Trigger: Window open for more than 10 minutes
# Action: TTS announcement every minute until closed
# -----------------------------------------------------------------------------
- id: bed_window_open_too_long
  alias: "Bedroom Window Open Too Long"
  description: "Alerts when bedroom window is open for more than 10 minutes"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.bed_window_contact_sensor_contact
      to: "on"
      for:
        minutes: 10

  action:
    - repeat:
        while:
          - condition: state
            entity_id: binary_sensor.bed_window_contact_sensor_contact
            state: "on"
        sequence:
          - service: tts.google_translate_say
            data:
              entity_id: media_player.kitchen_display
              message: >
                {% set minutes = ((now() - states.binary_sensor.bed_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Bedroom window has been open for {{ minutes }} minutes.
              language: "en"
          - service: notify.mobile_app_22111317pg
            data:
              title: "ü™ü Bedroom Window"
              message: >
                {% set minutes = ((now() - states.binary_sensor.bed_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Open for {{ minutes }} minutes
              data:
                channel: "Alerts"
                importance: high
                tag: "bed_window"
          - delay:
              minutes: 1

# -----------------------------------------------------------------------------
# MAILBOX SENSOR ONLINE ALERT
# Trigger: Sensor becomes available (comes back online)
# Action: TTS announcement on ALL Google Home devices
# Quiet Hours: 23:00 - 06:00 (no announcements)
# -----------------------------------------------------------------------------
- id: mailbox_sensor_online
  alias: "Mailbox Sensor Online"
  description: "Announces when mailbox motion sensor comes back online"
  mode: single

  trigger:
    # Trigger when sensor availability changes to online
    - platform: state
      entity_id: binary_sensor.motion_detector_occupancy
      from: "unavailable"
    - platform: state
      entity_id: binary_sensor.motion_detector_occupancy
      from: "unknown"

  condition:
    # Quiet hours: no announcements between 23:00 and 06:00
    - condition: time
      after: "06:00:00"
      before: "23:00:00"

  action:
    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: "Mailbox sensor is now online."
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "üì° Sensor Online"
        message: "Mailbox motion sensor is back online"
        data:
          channel: "Info"
          importance: default

# =============================================================================
# HEATER NOTIFICATIONS
# Purpose: Notify when heaters start/stop heating
# =============================================================================

# -----------------------------------------------------------------------------
# STUDY HEATER - STARTED
# -----------------------------------------------------------------------------
- id: study_heater_started
  alias: "Study Heater Started"
  description: "Notifies when study heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.study_thermostat
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "üî• Study Heater ON"
        message: "Target: {{ state_attr('climate.study_thermostat', 'temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_study"

# -----------------------------------------------------------------------------
# STUDY HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: study_heater_stopped
  alias: "Study Heater Stopped"
  description: "Notifies when study heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.study_thermostat
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "‚ùÑÔ∏è Study Heater OFF"
        message: "Current: {{ state_attr('climate.study_thermostat', 'current_temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_study"

# -----------------------------------------------------------------------------
# LIVING INNER HEATER - STARTED
# -----------------------------------------------------------------------------
- id: living_inner_heater_started
  alias: "Living Inner Heater Started"
  description: "Notifies when living inner heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_inner
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "üî• Living Inner Heater ON"
        message: "Target: {{ state_attr('climate.living_thermostat_inner', 'temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_inner"

# -----------------------------------------------------------------------------
# LIVING INNER HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: living_inner_heater_stopped
  alias: "Living Inner Heater Stopped"
  description: "Notifies when living inner heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_inner
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "‚ùÑÔ∏è Living Inner Heater OFF"
        message: "Current: {{ state_attr('climate.living_thermostat_inner', 'current_temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_inner"

# -----------------------------------------------------------------------------
# LIVING OUTER HEATER - STARTED
# -----------------------------------------------------------------------------
- id: living_outer_heater_started
  alias: "Living Outer Heater Started"
  description: "Notifies when living outer heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_outer
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "üî• Living Outer Heater ON"
        message: "Target: {{ state_attr('climate.living_thermostat_outer', 'temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_outer"

# -----------------------------------------------------------------------------
# LIVING OUTER HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: living_outer_heater_stopped
  alias: "Living Outer Heater Stopped"
  description: "Notifies when living outer heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_outer
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "‚ùÑÔ∏è Living Outer Heater OFF"
        message: "Current: {{ state_attr('climate.living_thermostat_outer', 'current_temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_outer"

# -----------------------------------------------------------------------------
# BEDROOM HEATER - STARTED
# -----------------------------------------------------------------------------
- id: bed_heater_started
  alias: "Bedroom Heater Started"
  description: "Notifies when bedroom heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.bed_thermostat
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "üî• Bedroom Heater ON"
        message: "Target: {{ state_attr('climate.bed_thermostat', 'temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_bedroom"

# -----------------------------------------------------------------------------
# BEDROOM HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: bed_heater_stopped
  alias: "Bedroom Heater Stopped"
  description: "Notifies when bedroom heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.bed_thermostat
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "‚ùÑÔ∏è Bedroom Heater OFF"
        message: "Current: {{ state_attr('climate.bed_thermostat', 'current_temperature') }}¬∞C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_bedroom"
