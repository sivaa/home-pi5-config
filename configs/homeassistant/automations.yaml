# =============================================================================
# HOME ASSISTANT AUTOMATIONS
# Purpose: Event-driven actions for smart home
# =============================================================================

# -----------------------------------------------------------------------------
# BATHROOM MOTION ANNOUNCEMENT
# Trigger: Motion detected in bathroom
# Action: TTS announcement on Kitchen Display
# Cooldown: 30 seconds (prevents spam from continuous motion)
# -----------------------------------------------------------------------------
- id: bathroom_motion_announcement
  alias: "Bathroom Motion TTS Announcement"
  description: "Announces when someone enters the bathroom"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.motion_detector_occupancy
      to: "on"

  condition:
    # 30-second cooldown to prevent spam
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.bathroom_motion_tts_announcement', 'last_triggered')).total_seconds() > 30
           if state_attr('automation.bathroom_motion_tts_announcement', 'last_triggered') is not none
           else true }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id: media_player.kitchen_display
        message: "Someone is in the bathroom"
        language: "en"

# -----------------------------------------------------------------------------
# CO2 LEVEL ALERT
# Trigger: CO2 level rises above 1200 ppm
# Action: TTS announcement to ventilate
# Cooldown: 10 minutes (prevents repeated announcements)
# -----------------------------------------------------------------------------
- id: co2_high_alert
  alias: "CO2 High Level Alert"
  description: "Announces when CO2 levels are too high and ventilation is needed"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.co2_co2
      above: 1200

  condition:
    # 10-minute cooldown to prevent spam
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_high_level_alert', 'last_triggered')).total_seconds() > 600
           if state_attr('automation.co2_high_level_alert', 'last_triggered') is not none
           else true }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id: media_player.kitchen_display
        message: >
          Nithya, the Criuse Owner, please ventilate. The current CO2 level is above {{ (states('sensor.co2_co2') | int // 100) * 100 }}.
        language: "en"

# -----------------------------------------------------------------------------
# CO2 CRITICAL ALERT
# Trigger: CO2 level rises above 1600 ppm (very high)
# Action: Urgent TTS announcement
# Cooldown: 5 minutes (more frequent due to urgency)
# -----------------------------------------------------------------------------
- id: co2_critical_alert
  alias: "CO2 Critical Level Alert"
  description: "Urgent announcement when CO2 levels are dangerously high"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.co2_co2
      above: 1600

  condition:
    # 5-minute cooldown (shorter due to urgency)
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_critical_level_alert', 'last_triggered')).total_seconds() > 300
           if state_attr('automation.co2_critical_level_alert', 'last_triggered') is not none
           else true }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id: media_player.kitchen_display
        message: >
          Warning! CO2 level is very high at {{ (states('sensor.co2_co2') | int // 100) * 100 }}. Please open windows immediately!
        language: "en"

# -----------------------------------------------------------------------------
# CO2 GOOD LEVEL NOTIFICATION
# Trigger: CO2 level drops below 500 ppm (good air quality)
# Action: Thank Nithya and announce ventilation complete
# Cooldown: 30 minutes (stable good level)
# -----------------------------------------------------------------------------
- id: co2_good_level
  alias: "CO2 Good Level Notification"
  description: "Announces when air quality is good after ventilation"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.co2_co2
      below: 500

  condition:
    # 30-minute cooldown
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_good_level_notification', 'last_triggered')).total_seconds() > 1800
           if state_attr('automation.co2_good_level_notification', 'last_triggered') is not none
           else true }}
    # Only announce if there was a recent high alert (within last 2 hours)
    - condition: template
      value_template: >
        {% set high_alert = state_attr('automation.co2_high_level_alert', 'last_triggered') %}
        {% set critical_alert = state_attr('automation.co2_critical_level_alert', 'last_triggered') %}
        {% set alerts = [high_alert, critical_alert] | select('ne', none) | list %}
        {{ alerts | length > 0 and (now() - alerts | max).total_seconds() < 7200 }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id: media_player.kitchen_display
        message: >
          {% set high_alert = state_attr('automation.co2_high_level_alert', 'last_triggered') %}
          {% set critical_alert = state_attr('automation.co2_critical_level_alert', 'last_triggered') %}
          {% set alerts = [high_alert, critical_alert] | select('ne', none) | list %}
          {% set minutes = ((now() - alerts | max).total_seconds() / 60) | round(0) | int %}
          Thanks Nithya! Air quality is good now. Ventilated in {{ minutes }} minutes. You can close the windows.
        language: "en"
