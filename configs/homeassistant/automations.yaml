# =============================================================================
# HOME ASSISTANT AUTOMATIONS
# Purpose: Event-driven actions for smart home
# =============================================================================

# -----------------------------------------------------------------------------
# MAILBOX MOTION ALERT
# Trigger: Motion detected at mailbox (PIR sensor)
# Action: TTS announcement on ALL Google Home devices
# Quiet Hours: 23:00 - 06:00 (no announcements)
# Cooldown: 30 seconds (prevents spam from continuous motion)
# -----------------------------------------------------------------------------
- id: mailbox_motion_alert
  alias: "Mailbox Motion Alert"
  description: "Announces when motion is detected at the mailbox"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.motion_detector_occupancy
      to: "on"

  condition:
    # Quiet hours: no announcements between 23:00 and 06:00
    - condition: time
      after: "06:00:00"
      before: "23:00:00"
    # 30-second cooldown to prevent spam
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.mailbox_motion_alert', 'last_triggered')).total_seconds() > 30
           if state_attr('automation.mailbox_motion_alert', 'last_triggered') is not none
           else true }}

  action:
    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: "Mailbox opened"
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸ“¬ Mailbox"
        message: "Motion detected at mailbox"
        data:
          channel: "Alerts"
          importance: high

# -----------------------------------------------------------------------------
# CO2 LEVEL ALERT
# Trigger: CO2 level rises above 1200 ppm, OR every 30 min while high, OR on HA startup
# Action: TTS announcement to ventilate
# Cooldown: 30 minutes (prevents repeated announcements)
# Quiet Hours: 07:00-23:00 only
# -----------------------------------------------------------------------------
- id: co2_high_alert
  alias: "CO2 High Level Alert"
  description: "Announces when CO2 levels are too high and ventilation is needed"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.hallway_co2_co2
      above: 1200
    # Also trigger on HA startup to catch already-high levels
    - platform: homeassistant
      event: start
    # Periodic check every 30 minutes while CO2 stays high
    - platform: time_pattern
      minutes: "/30"

  condition:
    # Verify CO2 is actually above threshold (needed for startup trigger)
    - condition: numeric_state
      entity_id: sensor.hallway_co2_co2
      above: 1200
    # Only announce during waking hours (7 AM to 11 PM)
    - condition: time
      after: "07:00:00"
      before: "23:00:00"
    # 30-minute cooldown to match periodic trigger
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_high_level_alert', 'last_triggered')).total_seconds() > 1800
           if state_attr('automation.co2_high_level_alert', 'last_triggered') is not none
           else true }}

  action:
    # Smart TTS with retry logic - waits up to 5 min if Kitchen Display unavailable
    - service: script.smart_tts_co2_alert
      data:
        message: >
          Nithya, the Cruise Owner, please ventilate. The current CO2 level is above {{ (states('sensor.hallway_co2_co2') | int // 100) * 100 }}.
        co2_threshold: 1200
    - service: notify.mobile_app_22111317pg
      data:
        title: "âš ï¸ CO2 High"
        message: "CO2 above {{ states('sensor.hallway_co2_co2') }} ppm - please ventilate"
        data:
          channel: "Alerts"
          importance: high

# -----------------------------------------------------------------------------
# CO2 CRITICAL ALERT
# Trigger: Every 10 minutes, checks if CO2 > 1600 ppm
# Action: Urgent TTS announcement + mobile notification
# NOTE: NO quiet hours - safety critical, runs 24/7
# -----------------------------------------------------------------------------
- id: co2_critical_alert
  alias: "CO2 Critical Level Alert"
  description: "Checks every 10 minutes and announces if CO2 is dangerously high"
  mode: single

  trigger:
    # Check every 10 minutes
    - platform: time_pattern
      minutes: "/10"
    # Also trigger immediately when crossing threshold
    - platform: numeric_state
      entity_id: sensor.hallway_co2_co2
      above: 1600

  condition:
    # Only announce if CO2 is above critical level
    - condition: numeric_state
      entity_id: sensor.hallway_co2_co2
      above: 1600

  action:
    # Smart TTS with retry logic - waits up to 5 min if Kitchen Display unavailable
    - service: script.smart_tts_co2_alert
      data:
        message: >
          Warning! CO2 level is critical at {{ states('sensor.hallway_co2_co2') | int }}. Please open windows immediately!
        co2_threshold: 1600
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸš¨ CO2 CRITICAL"
        message: "CO2 at {{ states('sensor.hallway_co2_co2') }} ppm - OPEN WINDOWS NOW!"
        data:
          channel: "Critical"
          importance: max
          vibrationPattern: "100, 1000, 100, 1000, 100"

# -----------------------------------------------------------------------------
# CO2 GOOD LEVEL NOTIFICATION
# Trigger: CO2 level drops below 500 ppm (good air quality)
# Action: Thank Nithya and announce ventilation complete
# Cooldown: 30 minutes (stable good level)
# -----------------------------------------------------------------------------
- id: co2_good_level
  alias: "CO2 Good Level Notification"
  description: "Announces when air quality is good after ventilation"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.hallway_co2_co2
      below: 500

  condition:
    # Only announce during waking hours (7 AM to 11 PM)
    - condition: time
      after: "07:00:00"
      before: "23:00:00"
    # 30-minute cooldown
    - condition: template
      value_template: >
        {{ (now() - state_attr('automation.co2_good_level_notification', 'last_triggered')).total_seconds() > 1800
           if state_attr('automation.co2_good_level_notification', 'last_triggered') is not none
           else true }}
    # Only announce if there was a recent high alert (within last 2 hours)
    - condition: template
      value_template: >
        {% set high_alert = state_attr('automation.co2_high_level_alert', 'last_triggered') %}
        {% set critical_alert = state_attr('automation.co2_critical_level_alert', 'last_triggered') %}
        {% set alerts = [high_alert, critical_alert] | select('ne', none) | list %}
        {{ alerts | length > 0 and (now() - alerts | max).total_seconds() < 7200 }}

  action:
    # Good news announcement - use all speakers for reliability
    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: >
          {% set high_alert = state_attr('automation.co2_high_level_alert', 'last_triggered') %}
          {% set critical_alert = state_attr('automation.co2_critical_level_alert', 'last_triggered') %}
          {% set alerts = [high_alert, critical_alert] | select('ne', none) | list %}
          {% set minutes = ((now() - alerts | max).total_seconds() / 60) | round(0) | int %}
          Thanks Nithya! Air quality is good now. Ventilated in {{ minutes }} minutes. You can close the windows.
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "âœ… Air Quality Good"
        message: "CO2 now {{ states('sensor.hallway_co2_co2') }} ppm - windows can be closed"
        data:
          channel: "Info"
          importance: default

# -----------------------------------------------------------------------------
# BATHROOM WINDOW OPEN TOO LONG
# Trigger: Window open for more than 10 minutes
# Action: TTS announcement every minute until closed
# -----------------------------------------------------------------------------
- id: bath_window_open_too_long
  alias: "Bathroom Window Open Too Long"
  description: "Alerts when bathroom window is open for more than 10 minutes"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.bath_window_contact_sensor_contact
      to: "on"
      for:
        minutes: 10

  action:
    - repeat:
        while:
          - condition: state
            entity_id: binary_sensor.bath_window_contact_sensor_contact
            state: "on"
        sequence:
          - service: tts.google_translate_say
            data:
              entity_id: media_player.kitchen_display
              message: >
                {% set minutes = ((now() - states.binary_sensor.bath_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Bathroom window has been open for {{ minutes }} minutes.
              language: "en"
          - service: notify.mobile_app_22111317pg
            data:
              title: "ðŸªŸ Bathroom Window"
              message: >
                {% set minutes = ((now() - states.binary_sensor.bath_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Open for {{ minutes }} minutes
              data:
                channel: "Alerts"
                importance: high
                tag: "bath_window"
          - delay:
              minutes: 1

# -----------------------------------------------------------------------------
# BEDROOM WINDOW OPEN TOO LONG
# Trigger: Window open for more than 10 minutes
# Action: TTS announcement every minute until closed
# -----------------------------------------------------------------------------
- id: bed_window_open_too_long
  alias: "Bedroom Window Open Too Long"
  description: "Alerts when bedroom window is open for more than 10 minutes"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.bed_window_contact_sensor_contact
      to: "on"
      for:
        minutes: 10

  action:
    - repeat:
        while:
          - condition: state
            entity_id: binary_sensor.bed_window_contact_sensor_contact
            state: "on"
        sequence:
          - service: tts.google_translate_say
            data:
              entity_id: media_player.kitchen_display
              message: >
                {% set minutes = ((now() - states.binary_sensor.bed_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Bedroom window has been open for {{ minutes }} minutes.
              language: "en"
          - service: notify.mobile_app_22111317pg
            data:
              title: "ðŸªŸ Bedroom Window"
              message: >
                {% set minutes = ((now() - states.binary_sensor.bed_window_contact_sensor_contact.last_changed).total_seconds() / 60) | round(0) | int %}
                Open for {{ minutes }} minutes
              data:
                channel: "Alerts"
                importance: high
                tag: "bed_window"
          - delay:
              minutes: 1

# -----------------------------------------------------------------------------
# MAILBOX SENSOR ONLINE ALERT
# Trigger: Sensor becomes available (comes back online)
# Action: TTS announcement on ALL Google Home devices
# Quiet Hours: 23:00 - 06:00 (no announcements)
# -----------------------------------------------------------------------------
- id: mailbox_sensor_online
  alias: "Mailbox Sensor Online"
  description: "Announces when mailbox motion sensor comes back online"
  mode: single

  trigger:
    # Trigger when sensor availability changes to online
    - platform: state
      entity_id: binary_sensor.motion_detector_occupancy
      from: "unavailable"
    - platform: state
      entity_id: binary_sensor.motion_detector_occupancy
      from: "unknown"

  condition:
    # Quiet hours: no announcements between 23:00 and 06:00
    - condition: time
      after: "06:00:00"
      before: "23:00:00"

  action:
    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: "Mailbox sensor is now online."
        language: "en"
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸ“¡ Sensor Online"
        message: "Mailbox motion sensor is back online"
        data:
          channel: "Info"
          importance: default

# =============================================================================
# HEATER NOTIFICATIONS
# Purpose: Notify when heaters start/stop heating
# =============================================================================

# -----------------------------------------------------------------------------
# STUDY HEATER - STARTED
# -----------------------------------------------------------------------------
- id: study_heater_started
  alias: "Study Heater Started"
  description: "Notifies when study heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.study_thermostat
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸ”¥ Study Heater ON"
        message: "Target: {{ state_attr('climate.study_thermostat', 'temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_study"

# -----------------------------------------------------------------------------
# STUDY HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: study_heater_stopped
  alias: "Study Heater Stopped"
  description: "Notifies when study heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.study_thermostat
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "â„ï¸ Study Heater OFF"
        message: "Current: {{ state_attr('climate.study_thermostat', 'current_temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_study"

# -----------------------------------------------------------------------------
# LIVING INNER HEATER - STARTED
# -----------------------------------------------------------------------------
- id: living_inner_heater_started
  alias: "Living Inner Heater Started"
  description: "Notifies when living inner heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_inner
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸ”¥ Living Inner Heater ON"
        message: "Target: {{ state_attr('climate.living_thermostat_inner', 'temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_inner"

# -----------------------------------------------------------------------------
# LIVING INNER HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: living_inner_heater_stopped
  alias: "Living Inner Heater Stopped"
  description: "Notifies when living inner heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_inner
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "â„ï¸ Living Inner Heater OFF"
        message: "Current: {{ state_attr('climate.living_thermostat_inner', 'current_temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_inner"

# -----------------------------------------------------------------------------
# LIVING OUTER HEATER - STARTED
# -----------------------------------------------------------------------------
- id: living_outer_heater_started
  alias: "Living Outer Heater Started"
  description: "Notifies when living outer heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_outer
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸ”¥ Living Outer Heater ON"
        message: "Target: {{ state_attr('climate.living_thermostat_outer', 'temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_outer"

# -----------------------------------------------------------------------------
# LIVING OUTER HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: living_outer_heater_stopped
  alias: "Living Outer Heater Stopped"
  description: "Notifies when living outer heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.living_thermostat_outer
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "â„ï¸ Living Outer Heater OFF"
        message: "Current: {{ state_attr('climate.living_thermostat_outer', 'current_temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_living_outer"

# -----------------------------------------------------------------------------
# BEDROOM HEATER - STARTED
# -----------------------------------------------------------------------------
- id: bed_heater_started
  alias: "Bedroom Heater Started"
  description: "Notifies when bedroom heater starts heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.bed_thermostat
      attribute: hvac_action
      to: "heating"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸ”¥ Bedroom Heater ON"
        message: "Target: {{ state_attr('climate.bed_thermostat', 'temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_bedroom"

# -----------------------------------------------------------------------------
# BEDROOM HEATER - STOPPED
# -----------------------------------------------------------------------------
- id: bed_heater_stopped
  alias: "Bedroom Heater Stopped"
  description: "Notifies when bedroom heater stops heating"
  mode: single

  trigger:
    - platform: state
      entity_id: climate.bed_thermostat
      attribute: hvac_action
      from: "heating"
      to: "idle"

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "â„ï¸ Bedroom Heater OFF"
        message: "Current: {{ state_attr('climate.bed_thermostat', 'current_temperature') }}Â°C"
        data:
          channel: "Heater"
          importance: default
          tag: "heater_bedroom"

# =============================================================================
# THERMOSTAT AUDIT LOGGING
# Purpose: Track ALL setpoint changes for debugging and accountability
# =============================================================================

# -----------------------------------------------------------------------------
# THERMOSTAT SETPOINT CHANGE AUDIT
# Trigger: ANY change to setpoint temperature on ANY thermostat
# Action: Mobile notification with old/new values and timestamp
# Why: To catch rogue temperature changes from unknown sources
# -----------------------------------------------------------------------------
- id: thermostat_setpoint_changed_audit
  alias: "Thermostat Setpoint Changed (Audit)"
  description: "Sends notification when any thermostat setpoint changes - for audit tracking"
  mode: parallel

  trigger:
    - platform: state
      entity_id:
        - climate.study_thermostat
        - climate.living_thermostat_inner
        - climate.living_thermostat_outer
        - climate.bed_thermostat
      attribute: temperature

  condition:
    # Only trigger if temperature actually changed (not just state refresh)
    - condition: template
      value_template: >
        {{ trigger.from_state.attributes.temperature is defined
           and trigger.to_state.attributes.temperature is defined
           and trigger.from_state.attributes.temperature != trigger.to_state.attributes.temperature }}

  action:
    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸŒ¡ï¸ Setpoint Changed"
        message: >
          {{ trigger.to_state.name }}
          {{ trigger.from_state.attributes.temperature }}Â°C â†’ {{ trigger.to_state.attributes.temperature }}Â°C
          at {{ now().strftime('%H:%M:%S') }}
        data:
          channel: "Audit"
          importance: high
          tag: "setpoint_{{ trigger.entity_id }}"

# =============================================================================
# WINDOW-HEATER SAFETY AUTOMATIONS
# Purpose: Turn off heaters when windows/doors open, resume when all closed
# =============================================================================

# -----------------------------------------------------------------------------
# DOOR OPEN FOR 2 MINUTES - TURN OFF ALL HEATERS
# Trigger: Balcony door or main door open for 2 minutes
# Action: Turn off all heaters, notify user
# Note: If door closes within 2 minutes, this automation does NOT fire
# FIX: Uses guard flag to prevent state overwrite and duplicate notifications
# -----------------------------------------------------------------------------
- id: door_open_turn_off_heaters
  alias: "Door Open 2min - Turn Off All Heaters"
  description: "When balcony door or main door stays open for 2 minutes, turn off all heaters"
  mode: single
  max_exceeded: silent

  trigger:
    - platform: state
      entity_id:
        - binary_sensor.living_window_contact_sensor_balcony_door_contact
        - binary_sensor.hallway_window_contact_sensor_main_door_contact
      to: "on"
      for:
        minutes: 2

  variables:
    door_name: >
      {% set names = {
        'binary_sensor.living_window_contact_sensor_balcony_door_contact': 'Balcony Door',
        'binary_sensor.hallway_window_contact_sensor_main_door_contact': 'Main Door'
      } %}
      {{ names.get(trigger.entity_id, trigger.entity_id) }}

    heaters_running: >
      {% set running = [] %}
      {% if state_attr('climate.study_thermostat', 'hvac_action') == 'heating' %}
        {% set running = running + ['Study'] %}
      {% endif %}
      {% if state_attr('climate.living_thermostat_inner', 'hvac_action') == 'heating' %}
        {% set running = running + ['Living Inner'] %}
      {% endif %}
      {% if state_attr('climate.living_thermostat_outer', 'hvac_action') == 'heating' %}
        {% set running = running + ['Living Outer'] %}
      {% endif %}
      {% if state_attr('climate.bed_thermostat', 'hvac_action') == 'heating' %}
        {% set running = running + ['Bedroom'] %}
      {% endif %}
      {{ running | join(', ') if running else 'None' }}

  condition:
    # Guard flag must be OFF (heaters not already turned off by another window/door)
    - condition: state
      entity_id: input_boolean.heaters_off_due_to_window
      state: "off"
    # At least one heater must be in 'heat' mode
    - condition: template
      value_template: >
        {{ states('climate.study_thermostat') == 'heat'
           or states('climate.living_thermostat_inner') == 'heat'
           or states('climate.living_thermostat_outer') == 'heat'
           or states('climate.bed_thermostat') == 'heat' }}

  action:
    # Set guard flag FIRST (prevents race conditions and duplicate notifications)
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.heaters_off_due_to_window

    # SAVE current heater states (now protected by guard)
    - service: "input_boolean.turn_{{ 'on' if states('climate.study_thermostat') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.study_heater_was_on
    - service: "input_boolean.turn_{{ 'on' if states('climate.living_thermostat_inner') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.living_inner_heater_was_on
    - service: "input_boolean.turn_{{ 'on' if states('climate.living_thermostat_outer') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.living_outer_heater_was_on
    - service: "input_boolean.turn_{{ 'on' if states('climate.bed_thermostat') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.bedroom_heater_was_on

    # SAVE current setpoints BEFORE turning off
    # (TRVZB firmware drops setpoint to frost protection when mode is set to off)
    - service: input_number.set_value
      target:
        entity_id: input_number.study_heater_saved_temp
      data:
        value: "{{ state_attr('climate.study_thermostat', 'temperature') | float(18) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.living_inner_heater_saved_temp
      data:
        value: "{{ state_attr('climate.living_thermostat_inner', 'temperature') | float(18) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.living_outer_heater_saved_temp
      data:
        value: "{{ state_attr('climate.living_thermostat_outer', 'temperature') | float(18) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.bedroom_heater_saved_temp
      data:
        value: "{{ state_attr('climate.bed_thermostat', 'temperature') | float(18) }}"

    # Turn off all heaters
    - service: climate.set_hvac_mode
      target:
        entity_id:
          - climate.study_thermostat
          - climate.living_thermostat_inner
          - climate.living_thermostat_outer
          - climate.bed_thermostat
      data:
        hvac_mode: "off"

    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: >-
          {{ door_name }} open 2 minutes.
          {%- if heaters_running != 'None' %} Pausing {{ heaters_running }}.
          {%- else %} No heaters active.
          {%- endif %}
        language: "en"

    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸšª {{ door_name }}"
        message: >-
          Open 2 min.
          {%- if heaters_running != 'None' %} Paused: {{ heaters_running }}
          {%- else %} No heaters active
          {%- endif %}
        data:
          channel: "Critical"
          importance: max
          tag: "window_heater_safety"

# -----------------------------------------------------------------------------
# WINDOW OPEN FOR 30 SECONDS - TURN OFF ALL HEATERS
# Trigger: Any window open for 30 seconds
# Action: Turn off all heaters, notify user
# Note: If window closes within 30 seconds, this automation does NOT fire
# FIX: Uses guard flag to prevent state overwrite and duplicate notifications
# -----------------------------------------------------------------------------
- id: window_open_turn_off_heaters
  alias: "Window Open 30s - Turn Off All Heaters"
  description: "When any window stays open for 30 seconds, turn off all heaters"
  mode: single
  max_exceeded: silent

  trigger:
    - platform: state
      entity_id:
        - binary_sensor.bath_window_contact_sensor_contact
        - binary_sensor.bed_window_contact_sensor_contact
        - binary_sensor.kitchen_window_contact_sensor_contact
        - binary_sensor.study_window_contact_sensor_large_contact
        - binary_sensor.study_window_contact_sensor_small_contact
        - binary_sensor.living_window_contact_sensor_window_contact
      to: "on"
      for:
        seconds: 30

  variables:
    window_name: >
      {% set names = {
        'binary_sensor.bath_window_contact_sensor_contact': 'Bathroom Window',
        'binary_sensor.bed_window_contact_sensor_contact': 'Bedroom Window',
        'binary_sensor.kitchen_window_contact_sensor_contact': 'Kitchen Window',
        'binary_sensor.study_window_contact_sensor_large_contact': 'Study Large Window',
        'binary_sensor.study_window_contact_sensor_small_contact': 'Study Small Window',
        'binary_sensor.living_window_contact_sensor_window_contact': 'Living Window'
      } %}
      {{ names.get(trigger.entity_id, trigger.entity_id) }}

    heaters_running: >
      {% set running = [] %}
      {% if state_attr('climate.study_thermostat', 'hvac_action') == 'heating' %}
        {% set running = running + ['Study'] %}
      {% endif %}
      {% if state_attr('climate.living_thermostat_inner', 'hvac_action') == 'heating' %}
        {% set running = running + ['Living Inner'] %}
      {% endif %}
      {% if state_attr('climate.living_thermostat_outer', 'hvac_action') == 'heating' %}
        {% set running = running + ['Living Outer'] %}
      {% endif %}
      {% if state_attr('climate.bed_thermostat', 'hvac_action') == 'heating' %}
        {% set running = running + ['Bedroom'] %}
      {% endif %}
      {{ running | join(', ') if running else 'None' }}

  condition:
    # Guard flag must be OFF (heaters not already turned off by another window/door)
    - condition: state
      entity_id: input_boolean.heaters_off_due_to_window
      state: "off"
    # At least one heater must be in 'heat' mode
    - condition: template
      value_template: >
        {{ states('climate.study_thermostat') == 'heat'
           or states('climate.living_thermostat_inner') == 'heat'
           or states('climate.living_thermostat_outer') == 'heat'
           or states('climate.bed_thermostat') == 'heat' }}

  action:
    # Set guard flag FIRST (prevents race conditions and duplicate notifications)
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.heaters_off_due_to_window

    # SAVE current heater states (now protected by guard)
    - service: "input_boolean.turn_{{ 'on' if states('climate.study_thermostat') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.study_heater_was_on
    - service: "input_boolean.turn_{{ 'on' if states('climate.living_thermostat_inner') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.living_inner_heater_was_on
    - service: "input_boolean.turn_{{ 'on' if states('climate.living_thermostat_outer') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.living_outer_heater_was_on
    - service: "input_boolean.turn_{{ 'on' if states('climate.bed_thermostat') == 'heat' else 'off' }}"
      target:
        entity_id: input_boolean.bedroom_heater_was_on

    # SAVE current setpoints BEFORE turning off
    # (TRVZB firmware drops setpoint to frost protection when mode is set to off)
    - service: input_number.set_value
      target:
        entity_id: input_number.study_heater_saved_temp
      data:
        value: "{{ state_attr('climate.study_thermostat', 'temperature') | float(18) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.living_inner_heater_saved_temp
      data:
        value: "{{ state_attr('climate.living_thermostat_inner', 'temperature') | float(18) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.living_outer_heater_saved_temp
      data:
        value: "{{ state_attr('climate.living_thermostat_outer', 'temperature') | float(18) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.bedroom_heater_saved_temp
      data:
        value: "{{ state_attr('climate.bed_thermostat', 'temperature') | float(18) }}"

    # Turn off all heaters
    - service: climate.set_hvac_mode
      target:
        entity_id:
          - climate.study_thermostat
          - climate.living_thermostat_inner
          - climate.living_thermostat_outer
          - climate.bed_thermostat
      data:
        hvac_mode: "off"

    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: >-
          {{ window_name }} open 30 seconds.
          {%- if heaters_running != 'None' %} Pausing {{ heaters_running }}.
          {%- else %} No heaters active.
          {%- endif %}
        language: "en"

    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸªŸ {{ window_name }}"
        message: >-
          Open 30s.
          {%- if heaters_running != 'None' %} Paused: {{ heaters_running }}
          {%- else %} No heaters active
          {%- endif %}
        data:
          channel: "Critical"
          importance: max
          tag: "window_heater_safety"

# -----------------------------------------------------------------------------
# ALL WINDOWS CLOSED - RESUME HEATING
# Trigger: ANY contact sensor closes
# Condition: ALL 8 sensors must be closed AND guard flag is ON
# Action: Restore heaters to saved state, clear guard flag
# FIX: Only runs if heaters were previously turned off by window automation
# -----------------------------------------------------------------------------
- id: all_windows_closed_resume_heaters
  alias: "All Windows Closed - Resume Heaters"
  description: "When all windows and doors are closed, turn heaters back on and notify"
  mode: single

  trigger:
    - platform: state
      entity_id:
        - binary_sensor.bath_window_contact_sensor_contact
        - binary_sensor.bed_window_contact_sensor_contact
        - binary_sensor.kitchen_window_contact_sensor_contact
        - binary_sensor.study_window_contact_sensor_large_contact
        - binary_sensor.study_window_contact_sensor_small_contact
        - binary_sensor.living_window_contact_sensor_balcony_door_contact
        - binary_sensor.living_window_contact_sensor_window_contact
        - binary_sensor.hallway_window_contact_sensor_main_door_contact
      to: "off"

  condition:
    # Guard flag must be ON (heaters were turned off by window automation)
    - condition: state
      entity_id: input_boolean.heaters_off_due_to_window
      state: "on"
    # ALL windows/doors must be closed
    - condition: state
      entity_id: binary_sensor.bath_window_contact_sensor_contact
      state: "off"
    - condition: state
      entity_id: binary_sensor.bed_window_contact_sensor_contact
      state: "off"
    - condition: state
      entity_id: binary_sensor.kitchen_window_contact_sensor_contact
      state: "off"
    - condition: state
      entity_id: binary_sensor.study_window_contact_sensor_large_contact
      state: "off"
    - condition: state
      entity_id: binary_sensor.study_window_contact_sensor_small_contact
      state: "off"
    - condition: state
      entity_id: binary_sensor.living_window_contact_sensor_balcony_door_contact
      state: "off"
    - condition: state
      entity_id: binary_sensor.living_window_contact_sensor_window_contact
      state: "off"
    - condition: state
      entity_id: binary_sensor.hallway_window_contact_sensor_main_door_contact
      state: "off"

  variables:
    heaters_restored: >
      {% set restored = [] %}
      {% if is_state('input_boolean.study_heater_was_on', 'on') %}
        {% set restored = restored + ['Study'] %}
      {% endif %}
      {% if is_state('input_boolean.living_inner_heater_was_on', 'on') %}
        {% set restored = restored + ['Living Inner'] %}
      {% endif %}
      {% if is_state('input_boolean.living_outer_heater_was_on', 'on') %}
        {% set restored = restored + ['Living Outer'] %}
      {% endif %}
      {% if is_state('input_boolean.bedroom_heater_was_on', 'on') %}
        {% set restored = restored + ['Bedroom'] %}
      {% endif %}
      {{ restored | join(', ') if restored else 'None' }}

  action:
    # Restore heaters to their saved states
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.study_thermostat
      data:
        hvac_mode: "{{ 'heat' if is_state('input_boolean.study_heater_was_on', 'on') else 'off' }}"

    - service: climate.set_hvac_mode
      target:
        entity_id: climate.living_thermostat_inner
      data:
        hvac_mode: "{{ 'heat' if is_state('input_boolean.living_inner_heater_was_on', 'on') else 'off' }}"

    - service: climate.set_hvac_mode
      target:
        entity_id: climate.living_thermostat_outer
      data:
        hvac_mode: "{{ 'heat' if is_state('input_boolean.living_outer_heater_was_on', 'on') else 'off' }}"

    - service: climate.set_hvac_mode
      target:
        entity_id: climate.bed_thermostat
      data:
        hvac_mode: "{{ 'heat' if is_state('input_boolean.bedroom_heater_was_on', 'on') else 'off' }}"

    # Reset open_window flag on TRVs (TRVZB sets this when mode=off)
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/[Study] Thermostat/set"
        payload: '{"open_window": "OFF"}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/[Bed] Thermostat/set"
        payload: '{"open_window": "OFF"}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/[Living] Thermostat Inner/set"
        payload: '{"open_window": "OFF"}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/[Living] Thermostat Outer/set"
        payload: '{"open_window": "OFF"}'

    # Delay for TRV to process mode change and open_window reset
    # TRVZB needs time between mode change and setpoint change (verified: 1s may be too short)
    - delay:
        seconds: 3

    # Restore saved setpoints (TRVZB drops setpoint to frost protection when turned off)
    - service: climate.set_temperature
      target:
        entity_id: climate.study_thermostat
      data:
        temperature: "{{ states('input_number.study_heater_saved_temp') | float(18) }}"
    - service: climate.set_temperature
      target:
        entity_id: climate.living_thermostat_inner
      data:
        temperature: "{{ states('input_number.living_inner_heater_saved_temp') | float(18) }}"
    - service: climate.set_temperature
      target:
        entity_id: climate.living_thermostat_outer
      data:
        temperature: "{{ states('input_number.living_outer_heater_saved_temp') | float(18) }}"
    - service: climate.set_temperature
      target:
        entity_id: climate.bed_thermostat
      data:
        temperature: "{{ states('input_number.bedroom_heater_saved_temp') | float(18) }}"

    # Clear the guard flag (ready for next window event)
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.heaters_off_due_to_window

    - delay:
        seconds: 2

    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: >-
          Windows closed.
          {%- if heaters_restored != 'None' %} Resuming {{ heaters_restored }}.
          {%- endif %}
        language: "en"

    - service: notify.mobile_app_22111317pg
      data:
        title: "âœ… Windows Closed"
        message: >-
          {%- if heaters_restored != 'None' %}Resumed: {{ heaters_restored }}
          {%- else %}No heaters to resume
          {%- endif %}
        data:
          channel: "Info"
          importance: default
          tag: "window_heater_safety"

# -----------------------------------------------------------------------------
# MAIN DOOR OPEN TOO LONG - REPEAT ALERT
# Trigger: Main door open for more than 3 minutes
# Action: Repeat TTS + mobile alert every 5 minutes until closed
# -----------------------------------------------------------------------------
- id: main_door_open_too_long
  alias: "Main Door Open Too Long - Repeat Alert"
  description: "If main door is open more than 3 minutes, alert every 5 minutes until closed"
  mode: single

  trigger:
    - platform: state
      entity_id: binary_sensor.hallway_window_contact_sensor_main_door_contact
      to: "on"
      for:
        minutes: 3

  action:
    - repeat:
        while:
          - condition: state
            entity_id: binary_sensor.hallway_window_contact_sensor_main_door_contact
            state: "on"
        sequence:
          - service: tts.google_translate_say
            data:
              entity_id:
                - media_player.kitchen_display
                - media_player.broken_display
                - media_player.master_bedroom_clock
              message: >
                Attention! The main door has been open for more than 3 minutes.
                Please close the main door.
              language: "en"

          - service: notify.mobile_app_22111317pg
            data:
              title: "ðŸšª Main Door Still Open!"
              message: "The main door has been open for more than 3 minutes. Please close it."
              data:
                channel: "Critical"
                importance: max
                tag: "main_door_open_alert"

          - delay:
              minutes: 5

# -----------------------------------------------------------------------------
# WINDOW OPEN COLD WEATHER ALERT
# Trigger: Any window/door open for 15 minutes when balcony temp < 18Â°C
# Action: TTS announcement on kitchen display every 2 minutes until closed
# Note: Independent of heater safety automations
# -----------------------------------------------------------------------------
- id: window_open_cold_weather_alert
  alias: "Window Open Cold Weather Alert"
  description: "Alert every 2 minutes when window open >15min and outdoor temp <18Â°C"
  mode: parallel
  max: 8

  trigger:
    - platform: state
      entity_id:
        - binary_sensor.bath_window_contact_sensor_contact
        - binary_sensor.bed_window_contact_sensor_contact
        - binary_sensor.kitchen_window_contact_sensor_contact
        - binary_sensor.study_window_contact_sensor_large_contact
        - binary_sensor.study_window_contact_sensor_small_contact
        - binary_sensor.living_window_contact_sensor_balcony_door_contact
        - binary_sensor.living_window_contact_sensor_window_contact
        - binary_sensor.hallway_window_contact_sensor_main_door_contact
      to: "on"
      for:
        minutes: 15

  condition:
    - condition: numeric_state
      entity_id: sensor.balcony_temperature_humidity_temperature
      below: 18

  variables:
    window_name: >
      {% set names = {
        'binary_sensor.bath_window_contact_sensor_contact': 'Bathroom Window',
        'binary_sensor.bed_window_contact_sensor_contact': 'Bedroom Window',
        'binary_sensor.kitchen_window_contact_sensor_contact': 'Kitchen Window',
        'binary_sensor.study_window_contact_sensor_large_contact': 'Study Large Window',
        'binary_sensor.study_window_contact_sensor_small_contact': 'Study Small Window',
        'binary_sensor.living_window_contact_sensor_balcony_door_contact': 'Balcony Door',
        'binary_sensor.living_window_contact_sensor_window_contact': 'Living Window',
        'binary_sensor.hallway_window_contact_sensor_main_door_contact': 'Main Door'
      } %}
      {{ names.get(trigger.entity_id, trigger.entity_id) }}

  action:
    - repeat:
        while:
          - condition: template
            value_template: "{{ is_state(trigger.entity_id, 'on') }}"
          - condition: numeric_state
            entity_id: sensor.balcony_temperature_humidity_temperature
            below: 18
        sequence:
          - service: tts.google_translate_say
            data:
              entity_id: media_player.kitchen_display
              message: >
                Attention! {{ window_name }} has been open for a long time
                and it's {{ states('sensor.balcony_temperature_humidity_temperature') | round(0) }} degrees outside.
                Please close it to keep the apartment warm.
              language: "en"
          - delay:
              minutes: 2

# -----------------------------------------------------------------------------
# PREVENT HEATING IF WINDOW OPEN
# Trigger: Any thermostat enters "heating" state
# Condition: At least one window/door is open
# Action: Turn off that thermostat, warn user
# Note: This prevents heaters from starting while windows are open
# -----------------------------------------------------------------------------
- id: prevent_heating_if_window_open
  alias: "Prevent Heating If Window Open"
  description: "When any heater starts heating, check if windows are open. If yes, turn it off."
  mode: parallel
  max: 4

  trigger:
    - platform: state
      entity_id:
        - climate.study_thermostat
        - climate.living_thermostat_inner
        - climate.living_thermostat_outer
        - climate.bed_thermostat
      attribute: hvac_action
      to: "heating"

  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.bath_window_contact_sensor_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.bed_window_contact_sensor_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.kitchen_window_contact_sensor_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.study_window_contact_sensor_large_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.study_window_contact_sensor_small_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.living_window_contact_sensor_window_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.living_window_contact_sensor_balcony_door_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.hallway_window_contact_sensor_main_door_contact
          state: "on"

  variables:
    heater_name: >
      {% set names = {
        'climate.study_thermostat': 'Study',
        'climate.living_thermostat_inner': 'Living Inner',
        'climate.living_thermostat_outer': 'Living Outer',
        'climate.bed_thermostat': 'Bedroom'
      } %}
      {{ names.get(trigger.entity_id, trigger.entity_id) }}

    # Map entity_id to helper IDs for state saving
    heater_id: >
      {% set ids = {
        'climate.study_thermostat': 'study',
        'climate.living_thermostat_inner': 'living_inner',
        'climate.living_thermostat_outer': 'living_outer',
        'climate.bed_thermostat': 'bedroom'
      } %}
      {{ ids.get(trigger.entity_id, 'unknown') }}

    bool_entity: "input_boolean.{{ heater_id }}_heater_was_on"
    number_entity: "input_number.{{ heater_id }}_heater_saved_temp"
    current_setpoint: "{{ state_attr(trigger.entity_id, 'temperature') | float(18) }}"

    open_windows: >
      {% set open = [] %}
      {% if is_state('binary_sensor.bath_window_contact_sensor_contact', 'on') %}
        {% set open = open + ['Bathroom'] %}
      {% endif %}
      {% if is_state('binary_sensor.bed_window_contact_sensor_contact', 'on') %}
        {% set open = open + ['Bedroom'] %}
      {% endif %}
      {% if is_state('binary_sensor.kitchen_window_contact_sensor_contact', 'on') %}
        {% set open = open + ['Kitchen'] %}
      {% endif %}
      {% if is_state('binary_sensor.study_window_contact_sensor_large_contact', 'on') %}
        {% set open = open + ['Study Large'] %}
      {% endif %}
      {% if is_state('binary_sensor.study_window_contact_sensor_small_contact', 'on') %}
        {% set open = open + ['Study Small'] %}
      {% endif %}
      {% if is_state('binary_sensor.living_window_contact_sensor_window_contact', 'on') %}
        {% set open = open + ['Living Window'] %}
      {% endif %}
      {% if is_state('binary_sensor.living_window_contact_sensor_balcony_door_contact', 'on') %}
        {% set open = open + ['Balcony Door'] %}
      {% endif %}
      {% if is_state('binary_sensor.hallway_window_contact_sensor_main_door_contact', 'on') %}
        {% set open = open + ['Main Door'] %}
      {% endif %}
      {{ open | join(', ') }}

  action:
    # -------------------------------------------------------------------------
    # FIX: Save THIS heater's state before turning off
    # NOTE: Do NOT set guard flag here - let window_open timer save ALL heaters
    # This prevents race condition where guard flag blocks window_open from saving
    # -------------------------------------------------------------------------
    - service: input_boolean.turn_on
      target:
        entity_id: "{{ bool_entity }}"

    - service: input_number.set_value
      target:
        entity_id: "{{ number_entity }}"
      data:
        value: "{{ current_setpoint }}"

    # Now turn off this specific heater
    - service: climate.set_hvac_mode
      target:
        entity_id: "{{ trigger.entity_id }}"
      data:
        hvac_mode: "off"

    - service: tts.google_translate_say
      data:
        entity_id:
          - media_player.kitchen_display
          - media_player.broken_display
          - media_player.master_bedroom_clock
        message: "{{ heater_name }} blocked. Close {{ open_windows }}."
        language: "en"

    - service: notify.mobile_app_22111317pg
      data:
        title: "ðŸš« {{ heater_name }} Blocked"
        message: "Windows open: {{ open_windows }}"
        data:
          channel: "Critical"
          importance: high
          tag: "heater_blocked_windows"

# =============================================================================
# TTS NOTIFICATION AUDIT LOGGING
# Purpose: Publish all TTS notifications to MQTT for dashboard logging
# =============================================================================

# -----------------------------------------------------------------------------
# TTS EVENT MQTT PUBLISHER
# Trigger: Any call to tts.google_translate_say service
# Action: Publish event details to dashboard/tts topic
# Fields: timestamp, message, devices, availability status
# -----------------------------------------------------------------------------
- id: tts_event_mqtt_publisher
  alias: "TTS Event MQTT Publisher"
  description: "Publishes all TTS notifications to MQTT for dashboard logging"
  mode: parallel
  max: 10

  trigger:
    - platform: event
      event_type: call_service
      event_data:
        domain: tts
        service: google_translate_say

  variables:
    devices: >
      {% set data = trigger.event.data.service_data %}
      {% if data.entity_id is string %}
        {{ [data.entity_id] }}
      {% else %}
        {{ data.entity_id | default([]) }}
      {% endif %}
    message: "{{ trigger.event.data.service_data.message | default('No message') }}"

    device_status: >
      {% set status = [] %}
      {% for device in devices %}
        {% set name = device | replace('media_player.', '') %}
        {% set state = states(device) %}
        {% set available = state not in ['unavailable', 'unknown'] %}
        {% set status = status + [{'device': name, 'available': available, 'state': state}] %}
      {% endfor %}
      {{ status }}

    all_available: >
      {{ device_status | selectattr('available', 'eq', true) | list | length == device_status | length }}

    any_available: >
      {{ device_status | selectattr('available', 'eq', true) | list | length > 0 }}

  action:
    - service: mqtt.publish
      data:
        topic: "dashboard/tts"
        payload: >
          {{
            {
              "timestamp": now().isoformat(),
              "event": "tts_call",
              "message": message,
              "devices": device_status,
              "success": any_available,
              "all_available": all_available,
              "automation": trigger.event.context.parent_id | default('manual')
            } | tojson
          }}
        retain: false
