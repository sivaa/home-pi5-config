services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"  # WebSocket for dashboard
    volumes:
      - /opt/mosquitto/config:/mosquitto/config
      - /opt/mosquitto/data:/mosquitto/data
      - /opt/mosquitto/log:/mosquitto/log

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt
    container_name: zigbee2mqtt
    restart: unless-stopped
    depends_on:
      - mosquitto
    ports:
      - "8080:8080"
    volumes:
      - /opt/zigbee2mqtt/data:/app/data
    devices:
      - /dev/serial/by-id/usb-Itead_Sonoff_Zigbee_3.0_USB_Dongle_Plus_V2_76e8abf6fd73ef1197c4c274d9b539e6-if00-port0:/dev/ttyUSB0
    environment:
      - TZ=Europe/Berlin

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    depends_on:
      - mosquitto
    ports:
      - "8123:8123"
    volumes:
      - /opt/homeassistant:/config
    environment:
      - TZ=Europe/Berlin
    privileged: true
    dns:
      - 192.168.0.1
      - 8.8.8.8

  influxdb:
    image: influxdb:1.8
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    volumes:
      - /opt/influxdb/data:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=homeassistant
      - INFLUXDB_HTTP_AUTH_ENABLED=false
      - INFLUXDB_REPORTING_DISABLED=true

  mqtt-influx-bridge:
    build:
      context: ../../services/mqtt-influx-bridge
    container_name: mqtt-influx-bridge
    restart: unless-stopped
    depends_on:
      - mosquitto
      - influxdb
    environment:
      - MQTT_URL=mqtt://mosquitto:1883
      - INFLUX_URL=http://influxdb:8086
      - INFLUX_DB=homeassistant
      - TZ=Europe/Berlin

  dashboard:
    image: nginx:alpine
    container_name: dashboard
    restart: unless-stopped
    ports:
      - "8888:80"
    volumes:
      - /opt/dashboard/www:/usr/share/nginx/html:ro
      - /opt/dashboard/nginx/dashboard.conf:/etc/nginx/conf.d/default.conf:ro
      - /opt/dashboard/nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - mosquitto
      - influxdb

  cast-ip-monitor:
    build:
      context: ../../services/cast-ip-monitor
    container_name: cast-ip-monitor
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/homeassistant:/ha-config
    environment:
      - SCAN_INTERVAL=300
      - TZ=Europe/Berlin

  heater-watchdog:
    build:
      context: ../../services/heater-watchdog
    container_name: heater-watchdog
    restart: unless-stopped
    depends_on:
      - homeassistant
    environment:
      - HA_URL=http://homeassistant:8123
      - HA_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJkZjJhY2UwMTBmNGY0Y2NiYTI0ZGZhMGUyZjg5NWYzNiIsImlhdCI6MTc2Njg1NjU1NywiZXhwIjoyMDgyMjE2NTU3fQ.2t04JrsGafT9hDhg0BniYG90i1O7a7DHqpdst9x3-no
      - CHECK_INTERVAL=300
      - NOTIFY_SERVICE=notify.mobile_app_22111317pg
      - TZ=Europe/Berlin
